{
  "timestamp": "20260115_024023",
  "model_name": "gemma-3-12b-it",
  "interrupted": false,
  "processed_count": 100,
  "total_count": 100,
  "multi_agent_mode": "simple_4agents",
  "gpu_info": {
    "api": true
  },
  "gpu_memory_after_load_gb": 0.0,
  "gpu_memory_during_inference_gb": 0.0,
  "gpu_memory_during_inference_max_gb": 0.0,
  "gpu_memory_during_inference_min_gb": 0.0,
  "api_model": true,
  "average_response_time_seconds": 147.64548673152925,
  "parsing_error_rate": 0.08,
  "parsing_errors_count": 8,
  "quality_metrics": {
    "массовая доля": {
      "средняя_точность": 0.4054715219421101,
      "precision": 0.5404255319148936,
      "recall": 0.5404255319148936,
      "f1": 0.5404255319148936,
      "tp": 127,
      "fp": 108,
      "fn": 108,
      "количество_сравнений": 85,
      "ошибки": [
        "Вещество Cl: предсказано отсутствует, истина 1.0",
        "Вещество so4: предсказано 52.5, истина отсутствует",
        "Вещество ci: предсказано 1.0, истина отсутствует",
        "Вещество SO4: предсказано отсутствует, истина 52.5",
        "Вещество K2O: предсказано отсутствует, истина 10.0",
        "Вещество P: предсказано 10.0, истина отсутствует",
        "Вещество P2O5: предсказано отсутствует, истина 10.0",
        "Вещество K: предсказано 10.0, истина отсутствует",
        "Вещество K2O: предсказано отсутствует, истина 16.0",
        "Вещество P: предсказано 16.0, истина отсутствует"
      ]
    },
    "прочее": {
      "средняя_точность": 0.2317969067969068,
      "precision": 0.4823529411764706,
      "recall": 0.1971153846153846,
      "f1": 0.27986348122866894,
      "tp": 41,
      "fp": 44,
      "fn": 167,
      "количество_сравнений": 78,
      "ошибки": [
        "Параметр стандарт: предсказано отсутствует, истина ту 20.15.71-142-05015182-2017",
        "Параметр марка: предсказано отсутствует, истина npks-8 (npk 8:20:30)",
        "Параметр масса нетто единицы: предсказано 1035000.0, истина отсутствует",
        "Параметр стандарт: предсказано отсутствует, истина ту 2181-073-05761695-2016",
        "Параметр масса нетто: предсказано отсутствует, истина 1035000.0",
        "Параметр количество: предсказано 15.0, истина отсутствует",
        "Параметр количество вагонов: предсказано отсутствует, истина 15.0",
        "Параметр марка: предсказано отсутствует, истина npk 16-16-16",
        "Параметр вес реквизита крепления: предсказано отсутствует, истина 1584.0",
        "Параметр масса упаковки (мешки): предсказано отсутствует, истина 100.0"
      ]
    }
  },
  "hyperparameters": {
    "max_new_tokens": 512,
    "model_name": "gemma-3-12b-it",
    "api_model": true,
    "multi_agent_mode": "simple_4agents"
  },
  "prompt_template": "build_prompt3",
  "prompt_full_text": "МУЛЬТИАГЕНТНЫЙ РЕЖИМ: simple_4agents\n\n================================================================================\nПРОМПТ 1: ИЗВЛЕЧЕНИЕ ЧИСЛОВЫХ ФРАГМЕНТОВ\n================================================================================\n\nТы — агент извлечения количественных атрибутов продукта из технического текста.\n\nТвоя задача — найти и извлечь все фрагменты текста, которые выражают\nизмеримые, нормируемые или спецификационные свойства продукта.\n\nИзвлекаемый фрагмент должен представлять собой:\n> «Сущность продукта + числовое значение + (при необходимости) единицы / допуск / стандарт»\n\nТо есть это должен быть осмысленный количественный атрибут, который может быть\nнормализован, сопоставлен и сравним в последующих шагах обработки.\n\n### ЧТО СЧИТАЕТСЯ АТРИБУТОМ\n\nИзвлекай фрагменты, описывающие:\n\n#### 1. Состав и концентрации\n- Массовые, молярные и процентные доли\n  (Азот 16%, P2O5 20%, содержание влаги не более 1.5%)\n- Формулы и марки удобрений\n  (N7-P20-K30-S3, 10-26-26)\n\n#### 2. Физические и логистические характеристики\n- Масса, объём, фасовка, упаковка\n  (мешки по 50 кг, биг-бэг 1000 кг, 25 л)\n- Плотность, насыпная масса, влажность и т.п.\n\n#### 3. Диапазоны, допуски, ограничения\n- ±, от…до…, не более, не менее, в пределах\n  (16% ±1%, от 6 до 12 г/л, не более 5%)\n\n#### 4. Нормативные числовые идентификаторы\n- ГОСТ, ТУ, ISO, EN и аналогичные стандарты с номерами\n\n### ЧТО НЕ ИЗВЛЕКАТЬ\n\nНе извлекай:\n- Даты, годы, номера партий\n- Телефоны, адреса, ИНН, артикулы\n- Позиционные номера, номера строк, страниц\n- Любые числа, не описывающие свойство продукта\n\n### ПРАВИЛА ИЗВЛЕЧЕНИЯ ФРАГМЕНТОВ\n\n1. Ты извлекаешь подстроки исходного текста, без перефразирования.\n2. Фрагмент должен быть минимальным, но семантически полным:\n   он должен включать:\n   - что измеряется\n   - и сколько\n3. Если рядом есть допуск или диапазон — включай его в тот же фрагмент:\n   правильно: «Азот 16% ±1%»  \n   неправильно: «Азот 16%» и «±1%» отдельно\n4. Если рядом несколько разных атрибутов — каждый извлекай отдельно.\n5. Если число относится к слову, оно должно быть извлечено вместе с этим словом:\n   правильно: «мешках по 50 кг»  \n   неправильно: «50 кг»\n\n### ПРИМЕР\n\nТекст:\nНИТРОАММОФОСКА, содержащая азот 16% ±1%, фосфор 16%, калий 16%, поставляется в мешках по 50 кг.\n\nПравильные фрагменты:\nАзот 16% ±1%\nФосфор 16%\nКалий 16%\nВ мешках по 50 кг\n\n### ТЕКСТ ДЛЯ АНАЛИЗА:\nКАЛИЙ СЕРНОКИСЛЫЙ ИЗ НЕФЕЛИНОВОГО СЫPЬЯ ТУ 20.15.52-089-05785164-2022, ПРЕДНАЗНАЧЕН ДЛЯ ПРИМЕНЕНИЯ В КАЧЕСТВЕ МИНЕРАЛЬНОГО УДОБРЕНИЯ В СЕЛЬСКОМ ХОЗЯЙСТВЕ, ПОЛУЧАЮТ ИЗ ВЕТВИ ТЕХНОЛОГИЧЕСКОГО ПРОЦЕССА ПРОИЗВОДСТВА СОДОПРОДУКТОВ ИЗ РАСТВОРОВ ГЛИНОЗЕМНОГО ПРОИЗВОДСТВА\n\n\n================================================================================\nПРОМПТ 2: ИЗВЛЕЧЕНИЕ МАССОВЫХ ДОЛЕЙ\n================================================================================\n\nТы — эксперт по извлечению массовых долей элементов из текстов об удобрениях.\n\nТвоя задача: из найденных числовых фрагментов извлечь только информацию о массовых долях химических элементов.\n\nМассовая доля может быть указана:\n- Прямо: \"массовая доля N 26%\", \"азот 16%\", \"N 26-28%\"\n- В марке: \"N7-P20-K30-S3\" означает N=7%, P2O5=20%, K2O=30%, S=3%\n- С операторами: \"не менее 10%\", \"не более 20%\"\n\nПравила:\n- Если указано \"МАССОВАЯ ДОЛЯ K В ПЕРЕСЧЕТЕ НА К2О\" - это \"массовая доля K2O\"\n- Если в марке указана доля - используй её, если нет прямого указания\n- Диапазоны указывай как [min, max]\n- Операторы: «не менее» - [min, null], «не более» - [null, max]\n- Названия элементов заменяй на химические обозначения (Кальций -> Ca)\n- Названия признаков пиши с маленькой буквы\n\nВыведи список найденных массовых долей в формате:\nвещество: значение (или [min, max] для диапазона)\nНапример:\nN: [16, 18]\n\nЕсли массовых долей нет, выведи \"Массовых долей не найдено\".\n\nЧисловые фрагменты для анализа:\n[Пример числовых фрагментов из предыдущего шага]\n\n\n================================================================================\nПРОМПТ 3: ИЗВЛЕЧЕНИЕ ПРОЧИХ ПАРАМЕТРОВ\n================================================================================\n\nТы — эксперт по извлечению прочих количественных параметров из текстов об удобрениях.\n\nТвоя задача: из найденных числовых фрагментов извлечь все параметры, КРОМЕ массовых долей элементов.\n\nИщи:\n- Массу нетто единицы (например, \"мешки по 50 кг\" -> масса нетто: 50 кг)\n- Массу брутто (масса с упаковкой)\n- Количество (мешков, поддонов, вагонов и др.)\n- Объем нетто единицы\n- Стандарты (ГОСТ, ТУ и др.)\n- Марки (если не использованы для массовых долей)\n\nПравила:\n- \"МЕШКИ ПО 50 КГ\" -> масса нетто: 50 кг\n- \"ПО 1000 КГ+5%\" -> масса брутто: 1050 кг\n- Для массы с упаковкой всегда \"масса брутто\"\n- Указывай единицы измерения (кроме \"марка\" и \"стандарт\")\n- Если параметра нет - не выводи его\n\nВыведи список найденных параметров в формате:\nпараметр: значение единица\n\nЕсли прочих параметров нет, выведи \"Прочих параметров не найдено\".\n\nЧисловые фрагменты для анализа:\n[Пример числовых фрагментов из предыдущего шага]\n\n\n================================================================================\nПРОМПТ 4: ФОРМИРОВАНИЕ JSON\n================================================================================\n\nТы агент, который формирует структурированный ответ в формате JSON.\n\n1. Объедини все массовые доли и прочие параметры в один JSON, строго по показанному образцу ниже.\n2. Если каких-то данных нет — выведи пустой список [] для этого поля.\n3. Все числа дай через точку, если есть десятичные.\n4. Для диапазона используй [min, max], [min, null] или [null, max].\n5. Для \"стандарт\" и \"марка\" используй поле \"значение\".\n6. Строго следуй названию каждого поля как в примере! Не добавляй ничего лишнего.\n\nПример ответа:\nОТВЕТ:\n```json\n{\n  \"массовая доля\": [\n    {\"вещество\": \"N\", \"массовая доля\": [26, 28]},\n    {\"вещество\": \"P2O5\", \"массовая доля\": [20, null]},\n    {\"вещество\": \"K2O\", \"массовая доля\": 20},\n    {\"вещество\": \"S\", \"массовая доля\": 3}\n  ],\n  \"прочее\": [\n    {\"параметр\": \"масса нетто единицы\", \"масса\": 50, \"единица\": \"кг\"},\n    {\"параметр\": \"масса брутто\", \"масса\": 1020, \"единица\": \"кг\"},\n    {\"параметр\": \"стандарт\", \"значение\": \"ТУ 2184-037-32496445-02\"},\n    {\"параметр\": \"марка\", \"значение\": \"N7-P20-K30-S3\"}\n  ]\n}\n\nВ начале обязательно выведи: ОТВЕТ:\n\nВозьми данные для заполнения json отсюда:\n\nМассовые доли:\n[Пример массовых долей из предыдущего шага]\n\nПрочие параметры:\n[Пример прочих параметров из предыдущего шага]\n\n",
  "prompt_info": {
    "mode": "simple_4agents",
    "prompts_used": [
      "NUMERIC_FRAGMENTS_EXTRACTION_PROMPT",
      "MASS_FRACTION_EXTRACTION_PROMPT",
      "OTHER_PARAMETERS_EXTRACTION_PROMPT",
      "JSON_FORMATION_PROMPT"
    ],
    "example_numeric_fragments_prompt": "\nТы — агент извлечения количественных атрибутов продукта из технического текста.\n\nТвоя задача — найти и извлечь все фрагменты текста, которые выражают\nизмеримые, нормируемые или спецификационные свойства продукта.\n\nИзвлекаемый фрагмент должен представлять собой:\n> «Сущность продукта + числовое значение + (при необходимости) единицы / допуск / стандарт»\n\nТо есть это должен быть осмысленный количественный атрибут, который может быть\nнормализован, сопоставлен и сравним в последующих шагах обработки.\n\n### ЧТО СЧИТАЕТСЯ АТРИБУТОМ\n\nИзвлекай фрагменты, описывающие:\n\n#### 1. Состав и концентрации\n- Массовые, молярные и процентные доли\n  (Азот 16%, P2O5 20%, содержание влаги не более 1.5%)\n- Формулы и марки удобрений\n  (N7-P20-K30-S3, 10-26-26)\n\n#### 2. Физические и логистические характеристики\n- Масса, объём, фасовка, упаковка\n  (мешки по 50 кг, биг-бэг 1000 кг, 25 л)\n- Плотность, насыпная масса, влажность и т.п.\n\n#### 3. Диапазоны, допуски, ограничения\n- ±, от…до…, не более, не менее, в пределах\n  (16% ±1%, от 6 до 12 г/л, не более 5%)\n\n#### 4. Нормативные числовые идентификаторы\n- ГОСТ, ТУ, ISO, EN и аналогичные стандарты с номерами\n\n### ЧТО НЕ ИЗВЛЕКАТЬ\n\nНе извлекай:\n- Даты, годы, номера партий\n- Телефоны, адреса, ИНН, артикулы\n- Позиционные номера, номера строк, страниц\n- Любые числа, не описывающие свойство продукта\n\n### ПРАВИЛА ИЗВЛЕЧЕНИЯ ФРАГМЕНТОВ\n\n1. Ты извлекаешь подстроки исходного текста, без перефразирования.\n2. Фрагмент должен быть минимальным, но семантически полным:\n   он должен включать:\n   - что измеряется\n   - и сколько\n3. Если рядом есть допуск или диапазон — включай его в тот же фрагмент:\n   правильно: «Азот 16% ±1%»  \n   неправильно: «Азот 16%» и «±1%» отдельно\n4. Если рядом несколько разных атрибутов — каждый извлекай отдельно.\n5. Если число относится к слову, оно должно быть извлечено вместе с этим словом:\n   правильно: «мешках по 50 кг»  \n   неправильно: «50 кг»\n\n### ПРИМЕР\n\nТекст:\nНИТРОАММОФОСКА, содержащая азот 16% ±1%, фосфор 16%, калий 16%, поставляется в мешках по 50 кг.\n\nПравильные фрагменты:\nАзот 16% ±1%\nФосфор 16%\nКалий 16%\nВ мешках по 50 кг\n\n### ТЕКСТ ДЛЯ АНАЛИЗА:\nКАЛИЙ СЕРНОКИСЛЫЙ ИЗ НЕФЕЛИНОВОГО СЫPЬЯ ТУ 20.15.52-089-05785164-2022, ПРЕДНАЗНАЧЕН ДЛЯ ПРИМЕНЕНИЯ В КАЧЕСТВЕ МИНЕРАЛЬНОГО УДОБРЕНИЯ В СЕЛЬСКОМ ХОЗЯЙСТВЕ, ПОЛУЧАЮТ ИЗ ВЕТВИ ТЕХНОЛОГИЧЕСКОГО ПРОЦЕССА ПРОИЗВОДСТВА СОДОПРОДУКТОВ ИЗ РАСТВОРОВ ГЛИНОЗЕМНОГО ПРОИЗВОДСТВА\n",
    "example_mass_fractions_prompt": "\nТы — эксперт по извлечению массовых долей элементов из текстов об удобрениях.\n\nТвоя задача: из найденных числовых фрагментов извлечь только информацию о массовых долях химических элементов.\n\nМассовая доля может быть указана:\n- Прямо: \"массовая доля N 26%\", \"азот 16%\", \"N 26-28%\"\n- В марке: \"N7-P20-K30-S3\" означает N=7%, P2O5=20%, K2O=30%, S=3%\n- С операторами: \"не менее 10%\", \"не более 20%\"\n\nПравила:\n- Если указано \"МАССОВАЯ ДОЛЯ K В ПЕРЕСЧЕТЕ НА К2О\" - это \"массовая доля K2O\"\n- Если в марке указана доля - используй её, если нет прямого указания\n- Диапазоны указывай как [min, max]\n- Операторы: «не менее» - [min, null], «не более» - [null, max]\n- Названия элементов заменяй на химические обозначения (Кальций -> Ca)\n- Названия признаков пиши с маленькой буквы\n\nВыведи список найденных массовых долей в формате:\nвещество: значение (или [min, max] для диапазона)\nНапример:\nN: [16, 18]\n\nЕсли массовых долей нет, выведи \"Массовых долей не найдено\".\n\nЧисловые фрагменты для анализа:\n[Пример числовых фрагментов]\n",
    "example_other_parameters_prompt": "\nТы — эксперт по извлечению прочих количественных параметров из текстов об удобрениях.\n\nТвоя задача: из найденных числовых фрагментов извлечь все параметры, КРОМЕ массовых долей элементов.\n\nИщи:\n- Массу нетто единицы (например, \"мешки по 50 кг\" -> масса нетто: 50 кг)\n- Массу брутто (масса с упаковкой)\n- Количество (мешков, поддонов, вагонов и др.)\n- Объем нетто единицы\n- Стандарты (ГОСТ, ТУ и др.)\n- Марки (если не использованы для массовых долей)\n\nПравила:\n- \"МЕШКИ ПО 50 КГ\" -> масса нетто: 50 кг\n- \"ПО 1000 КГ+5%\" -> масса брутто: 1050 кг\n- Для массы с упаковкой всегда \"масса брутто\"\n- Указывай единицы измерения (кроме \"марка\" и \"стандарт\")\n- Если параметра нет - не выводи его\n\nВыведи список найденных параметров в формате:\nпараметр: значение единица\n\nЕсли прочих параметров нет, выведи \"Прочих параметров не найдено\".\n\nЧисловые фрагменты для анализа:\n[Пример числовых фрагментов]\n",
    "example_json_formation_prompt": "\nТы агент, который формирует структурированный ответ в формате JSON.\n\n1. Объедини все массовые доли и прочие параметры в один JSON, строго по показанному образцу ниже.\n2. Если каких-то данных нет — выведи пустой список [] для этого поля.\n3. Все числа дай через точку, если есть десятичные.\n4. Для диапазона используй [min, max], [min, null] или [null, max].\n5. Для \"стандарт\" и \"марка\" используй поле \"значение\".\n6. Строго следуй названию каждого поля как в примере! Не добавляй ничего лишнего.\n\nПример ответа:\nОТВЕТ:\n```json\n{\n  \"массовая доля\": [\n    {\"вещество\": \"N\", \"массовая доля\": [26, 28]},\n    {\"вещество\": \"P2O5\", \"массовая доля\": [20, null]},\n    {\"вещество\": \"K2O\", \"массовая доля\": 20},\n    {\"вещество\": \"S\", \"массовая доля\": 3}\n  ],\n  \"прочее\": [\n    {\"параметр\": \"масса нетто единицы\", \"масса\": 50, \"единица\": \"кг\"},\n    {\"параметр\": \"масса брутто\", \"масса\": 1020, \"единица\": \"кг\"},\n    {\"параметр\": \"стандарт\", \"значение\": \"ТУ 2184-037-32496445-02\"},\n    {\"параметр\": \"марка\", \"значение\": \"N7-P20-K30-S3\"}\n  ]\n}\n\nВ начале обязательно выведи: ОТВЕТ:\n\nВозьми данные для заполнения json отсюда:\n\nМассовые доли:\n[Пример массовых долей]\n\nПрочие параметры:\n[Пример прочих параметров]\n"
  },
  "parsing_errors": [
    "Текст #6: ошибка в мультиагентном подходе. Ошибка: Agents 2 and 3 returned empty responses",
    "Текст #25: невалидный JSON. Ответ: {\n  \"массовая доля\": [\n    {\"вещество\": \"K2O\", \"массовая доля\": [51, 53]}\n  ],\n  \"прочее\": [\n    {\"параметр\": \"масса нетто единицы\", \"масса\": 25, \"единица\": \"кг\"},\n    {\"параметр\": \"количество\", \"масса\": 200, \"единица\": \"\"},\n    {\"параметр\": \"масса брутто\", \"масса\": 130, \"единица\": \"кг\"},\n    {\"параметр\": \"стандарт\", \"значение\": []},\n    {\"параметр\": \"марка\", \"значение\": []}\n  ]\n}",
    "Текст #27: невалидный JSON. Ответ: {\n  \"массовая доля\": [\n    {\"вещество\": \"N\", \"массовая доля\": 15.5}\n  ],\n  \"прочее\": [\n    {\"параметр\": \"масса нетто единицы\", \"масса\": 25, \"единица\": \"кг\"},\n    {\"параметр\": \"масса брутто\", \"масса\": [], \"единица\": \"\"},\n    {\"параметр\": \"стандарт\", \"значение\": []},\n    {\"параметр\": \"марка\", \"значение\": []}\n  ]\n}",
    "Текст #35: невалидный JSON. Ответ: {\n  \"массовая доля\": [],\n  \"прочее\": [\n    {\"параметр\": \"масса нетто единицы\", \"масса\": 919.5, \"единица\": \"кг\"},\n    {\"параметр\": \"количество\", \"масса\": 66, \"единица\": \"\"},\n    {\"параметр\": \"масса брутто\", \"масса\": 1386, \"единица\": \"кг\"},\n    {\"параметр\": \"стандарт\", \"значение\": \"\"},\n    {\"параметр\": \"марка\", \"значение\": \"\"}\n  ]\n}",
    "Текст #51: ошибка в мультиагентном подходе. Ошибка: Agents 2 and 3 returned empty responses",
    "Текст #64: ошибка в мультиагентном подходе. Ошибка: Agents 2 and 3 returned empty responses",
    "Текст #71: невалидный JSON. Ответ: {\n  \"массовая доля\": [],\n  \"прочее\": [\n    {\"параметр\": \"масса нетто единицы\", \"масса\": 25, \"единица\": \"кг\"},\n    {\"параметр\": \"масса брутто\", \"масса\": 1024, \"единица\": \"кг\"},\n    {\"параметр\": \"стандарт\", \"значение\": \"ГОСТ 4168-79\"},\n    {\"параметр\": \"марка\", \"значение\": \"\"}\n  ]\n}",
    "Текст #73: ошибка в мультиагентном подходе. Ошибка: Agents 2 and 3 returned empty responses"
  ],
  "total_samples": 100,
  "valid_json_count": 92,
  "invalid_json_count": 8,
  "gemini_analysis": {
    "status": "success",
    "analysis": "Как эксперт по оценке качества работы языковых моделей, я провел анализ предоставленных результатов тестирования модели gemma-3-12b-it.\n\n**Общая оценка:**\nМодель демонстрирует крайне низкие показатели качества извлечения данных (F1 54.04% для \"Массовая доля\" и 27.99% для \"Прочее\"). Это указывает на серьезные проблемы как с полнотой извлечения (Recall), так и с точностью (Precision). Значительное количество ошибок парсинга JSON и пустых ответов в мультиагентном режиме также свидетельствует о фундаментальных проблемах в настройке или понимании задачи.\n\n---\n\n### 1. Характерные ошибки модели\n\n*   **Низкая точность извлечения (F1-score):** Модель не способна надежно извлекать количественные атрибуты, что выражается в большом количестве как ложноотрицательных (пропуски), так и ложноположительных (лишние или некорректные) значений.\n*   **Проблемы с мультиагентным режимом:** Частые ошибки `Agents 2 and 3 returned empty responses` указывают на сбои в логике работы агентов или их координации. Это может быть связано с тем, что не все агенты находят релевантную информацию, но система ожидает ответа от каждого.\n*   **Невалидный (семантически) JSON:** Модель генерирует JSON с пустыми списками `[]` или пустыми строками `\"\"` для полей, где ожидаются конкретные значения (например, число или строка). Хотя это синтаксически корректный JSON, он не соответствует ожидаемой структуре данных для анализа и вызывает ошибки парсинга на этапе пост-обработки.\n*   **Пропуски истинных значений (False Negatives):** Модель часто не извлекает существующие атрибуты, такие как \"Вещество Cl: 1.0\", \"Вещество SO4: 52.5\", \"Параметр стандарт: ТУ...\" или \"Параметр марка: npks-8\". Это указывает на слабую способность модели идентифицировать все релевантные фрагменты.\n*   **Генерация ложных значений (False Positives):** Примеры вроде \"Вещество so4: предсказано 52.5, истина отсутствует\" или \"Параметр масса нетто единицы: предсказано 1035000.0, истина отсутствует\" показывают, что модель может ошибочно извлекать или придумывать значения. В случае с `1035000.0` это особенно критично, так как значение является очень большим и, вероятно, неверным в контексте.\n*   **Проблемы с распознаванием сложных паттернов:** Особенно для категории \"прочее\" (стандарты, марки), где паттерны могут быть менее предсказуемыми, модель часто ошибается.\n*   **Чувствительность к регистру и вариациям:** Пример `so4` vs `SO4` указывает на то, что модель не выполняет нормализацию или не распознает варианты одного и того же элемента.\n\n---\n\n### 2. Причины ошибок парсинга JSON\n\n*   **Проблемы в логике мультиагентного режима:** Ошибки `Agents 2 and 3 returned empty responses` могут быть вызваны несколькими причинами:\n    *   **Недостаточные инструкции для агентов 2 и 3:** Возможно, их промпты не позволяют им найти что-либо или они слишком узко специализированы и часто не находят подходящих данных в тексте.\n    *   **Ожидание ответа от всех агентов:** Система оркестрации агентов, вероятно, настроена так, что отсутствие ответа от любого агента считается ошибкой, вместо того чтобы обрабатывать его как \"ничего не найдено\".\n    *   **Недостаточная производительность модели:** Сама gemma-3-12b-it, когда выступает в роли агентов 2 и 3, может просто \"не справляться\" и возвращать пустой ответ.\n*   **Неясные указания по формированию JSON при отсутствии данных:** Промпт не дает явных инструкций, как поступать, если какой-либо атрибут не найден. Модель пытается быть \"полной\" и генерирует поля с пустыми списками или строками (например, `{\"масса\": [], \"единица\": \"\"}`, `{\"значение\": []}`). Это приводит к ошибкам, если последующий парсер ожидает конкретный тип данных (например, число или непустую строку).\n\n---\n\n### 3. Причины ошибок в извлечении данных\n\n*   **Сложность задачи для данной модели:** Извлечение структурированных данных (количественных атрибутов с сущностью, значением, единицами, допусками, стандартами) из неструктурированного текста является нетривиальной задачей. Gemma-3-12b-it, как относительно небольшая модель, может испытывать трудности с точным следованием всем сложным правилам промпта.\n*   **Недостаточная \"глубина\" понимания промпта:** Несмотря на подробный промпт, модель, вероятно, не всегда полностью учитывает все условия, такие как \"минимальный, но семантически полный фрагмент\", \"включать допуск\", \"что не извлекать\".\n*   **Проблемы с вниманием (Attention) и контекстом:** Возможно, модель не уделяет достаточного внимания всем частям входного текста или неспособна удерживать в памяти все правила извлечения на протяжении всего процесса генерации ответа.\n*   **Отсутствие явных примеров (Few-shot examples):** В предоставленном промпте отсутствуют примеры извлечения (input text -> desired JSON output). Для сложных задач извлечения наличие нескольких качественных примеров критически важно, так как они демонстрируют модели ожидаемый формат и поведение.\n*   **Недостаточная специализация:** Модель не обучена специально для данной задачи извлечения атрибутов из технических текстов, что сказывается на ее производительности.\n\n---\n\n### 4. Рекомендации по улучшению промпта\n\nПромпт достаточно подробный, но его можно улучшить, добавив явные указания на формат вывода и обработку краевых случаев.\n\n1.  **Добавить примеры JSON-вывода (Few-shot examples):** Это наиболее критичное изменение. Включите 2-3 примера:\n    *   Один пример, где найдены все типы атрибутов.\n    *   Один пример, где найдены только некоторые атрибуты.\n    *   Один пример, где ничего не найдено (или минимальный набор).\n    Это поможет модели лучше понять ожидаемую структуру JSON и как обрабатывать отсутствие данных.\n    *Пример:*\n    ```\n    ### ПРИМЕРЫ ВЫВОДА\n\n    **ТЕКСТ:** \"Удобрение NPK 16:16:16. Масса нетто 50 кг. Срок годности 2 года. ГОСТ 3456-2023. Содержание хлора не более 0.5%.\"\n    **ВЫВОД:**\n    {\n      \"массовая доля\": [\n        {\"вещество\": \"N\", \"массовая доля\": 16.0},\n        {\"вещество\": \"P2O5\", \"массовая доля\": 16.0},\n        {\"вещество\": \"K2O\", \"массовая доля\": 16.0},\n        {\"вещество\": \"Cl\", \"массовая доля\": 0.5, \"допуск\": \"не более\"}\n      ],\n      \"прочее\": [\n        {\"параметр\": \"масса нетто единицы\", \"масса\": 50, \"единица\": \"кг\"},\n        {\"параметр\": \"стандарт\", \"значение\": \"ГОСТ 3456-2023\"}\n      ]\n    }\n\n    **ТЕКСТ:** \"Азотное удобрение. Объем 1000 литров.\"\n    **ВЫВОД:**\n    {\n      \"массовая доля\": [],\n      \"прочее\": [\n        {\"параметр\": \"объем\", \"объем\": 1000, \"единица\": \"литров\"}\n      ]\n    }\n    ```\n\n2.  **Явно указать, как обрабатывать отсутствующие значения:**\n    *   Добавить правило: \"Если атрибут не найден в тексте, **не включай его в JSON-вывод**. Не используй пустые списки `[]` или пустые строки `\"\"` для обозначения отсутствия значения.\" (Это предотвратит невалидный JSON).\n\n3.  **Уточнить \"Сущность продукта\" и категории:**\n    *   В разделе \"Извлекаемый фрагмент должен представлять собой\" можно добавить: `> «[Категория: Массовая доля / Прочее] + Сущность продукта + числовое значение + (при необходимости) единицы / допуск / стандарт»`\n    *   Четче определить, что подразумевается под \"Сущность продукта\" для каждой категории. Например, для \"Массовой доли\" это \"Вещество\". Для \"Прочее\" это \"Параметр\".\n\n4.  **Добавить правила нормализации (если применимо):**\n    *   \"Для веществ используй стандартизированные обозначения (например, N, P2O5, SO4). Игнорируй регистр при поиске, но выводи в указанном формате.\"\n\n5.  **Усилить акцент на полноту и точность:**\n    *   \"Твоя задача — найти и извлечь *все* количественные атрибуты, соответствующие критериям, обеспечивая при этом *высокую точность*.\"\n    *   \"Каждый извлеченный фрагмент должен быть подтвержден исходным текстом.\"\n\n---\n\n### 5. Рекомендации по настройке гиперпараметров\n\n*   `max_new_tokens`: Текущее значение 512 может быть недостаточным для некоторых случаев, особенно если в тексте много атрибутов и JSON-вывод становится объемным. Рекомендуется **увеличить `max_new_tokens` до 1024 или 2048**, чтобы убедиться, что ответ не обрезается.\n*   `multi_agent_mode: \"simple_4agents\"`: Это основная проблема.\n    *   **Анализ агентов:** Необходимо глубоко проанализировать, какие задачи выполняют агенты 2 и 3, и почему они возвращают пустые ответы. Если их задачи нерелевантны для большинства входных текстов, возможно, следует пересмотреть архитектуру мультиагентной системы.\n    *   **Изменение логики оркестрации:** Если пустые ответы допустимы, система, которая собирает ответы агентов, должна быть изменена, чтобы не считать это ошибкой, а игнорировать пустые ответы или агрегировать их соответствующим образом.\n    *   **Отключение мультиагентности (временно или постоянно):** Если мультиагентный подход вызывает больше проблем, чем решает, рассмотрите возможность его полного отключения для данного типа задачи, если весь процесс извлечения можно эффективно реализовать в одном агенте. Если он все же необходим, убедитесь, что каждый агент имеет четкие, непересекающиеся задачи и адекватные инструкции.\n\n---\n\n### 6. Общие рекомендации по улучшению качества\n\n1.  **Файн-тюнинг модели (Fine-tuning):** Для достижения высокой точности в такой специфической и структурированной задаче, как извлечение количественных атрибутов из технических текстов, **файн-тюнинг gemma-3-12b-it на большом датасете примеров \"текст -> правильный JSON-вывод\" будет наиболее эффективным решением.** Это научит модель не только извлекать, но и форматировать данные точно по заданной схеме.\n2.  **Пост-обработка вывода:** Разработать отдельный модуль пост-обработки для:\n    *   **Валидации JSON:** Проверять синтаксическую и семантическую корректность JSON, исправляя мелкие ошибки (например, удаляя пустые списки/строки, если они не нужны).\n    *   **Нормализации данных:** Приводить извлеченные значения (например, вещества, единицы измерения) к стандартному формату.\n    *   **Проверки правдоподобия:** Сравнивать извлеченные числовые значения с известными диапазонами или контекстом, чтобы отсеивать явные аномалии (как `1035000.0`).\n3.  **Итеративное улучшение:**\n    *   Собирать больше данных об ошибках модели (особенно о False Negatives и False Positives).\n    *   Использовать эти данные для дальнейшего улучшения промпта и/или для создания датасета для файн-тюнинга.\n4.  **Стратегия \"Разделяй и властвуй\":** Разбить задачу на более простые подзадачи:\n    *   **Этап 1: Обнаружение числовых фрагментов:** Сначала извлечь все потенциально релевантные числовые фрагменты вместе с их контекстом.\n    *   **Этап 2: Классификация и структурирование:** Затем другой (или тот же) агент/модель классифицирует эти фрагменты по категориям (\"массовая доля\", \"прочее\") и преобразует их в требуемый JSON-формат. Это может уменьшить когнитивную нагрузку на модель на каждом шаге.\n5.  **Выбор более мощной модели:** Gemma 3B может быть недостаточно производительной для этой задачи. Если файн-тюнинг и улучшение промпта не дают желаемых результатов, рассмотрите использование более крупных моделей (например, Gemma-7B, Mistral, Llama-2/3), которые обладают лучшими способностями к следованию инструкциям и обработке сложных структурированных запросов.",
    "model_used": "gemini-2.5-flash"
  }
}