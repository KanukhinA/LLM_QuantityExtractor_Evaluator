{
  "timestamp": "20260111_171849",
  "model_name": "gemma-3-4b-it",
  "interrupted": false,
  "processed_count": 100,
  "total_count": 100,
  "multi_agent_mode": "simple_4agents",
  "gpu_info": {
    "api": true
  },
  "gpu_memory_after_load_gb": 0.0,
  "gpu_memory_during_inference_gb": 0.0,
  "gpu_memory_during_inference_max_gb": 0.0,
  "gpu_memory_during_inference_min_gb": 0.0,
  "api_model": true,
  "average_response_time_seconds": 16.887149665355683,
  "parsing_error_rate": 0.27,
  "parsing_errors_count": 27,
  "quality_metrics": {
    "массовая доля": {
      "средняя_точность": 0.06595959595959597,
      "precision": 0.125,
      "recall": 0.09615384615384616,
      "f1": 0.10869565217391305,
      "tp": 20,
      "fp": 140,
      "fn": 188,
      "количество_сравнений": 85,
      "ошибки": [
        "Вещество K2O: предсказано отсутствует, истина [29.0, 31.0]",
        "Вещество S: предсказано отсутствует, истина [2.0, None]",
        "Вещество P2O5: предсказано отсутствует, истина [19.0, 21.0]",
        "Вещество N: предсказано отсутствует, истина [7.0, 9.0]",
        "Вещество K2O: предсказано отсутствует, истина 50.0",
        "Вещество SO4: предсказано отсутствует, истина 52.5",
        "Вещество Cl: предсказано отсутствует, истина 1.0",
        "Вещество K2O: предсказано отсутствует, истина 10.0",
        "Вещество N: предсказано [20.0, 20.0], истина 20.0",
        "Вещество K: предсказано [10.0, 10.0], истина отсутствует"
      ]
    },
    "прочее": {
      "средняя_точность": 0.10952380952380952,
      "precision": 0.391304347826087,
      "recall": 0.1291866028708134,
      "f1": 0.19424460431654675,
      "tp": 27,
      "fp": 42,
      "fn": 182,
      "количество_сравнений": 79,
      "ошибки": [
        "Параметр стандарт: предсказано отсутствует, истина ту 20.15.52-089-05785164-2022",
        "Параметр стандарт: предсказано отсутствует, истина ту 20.15.71-142-05015182-2017",
        "Параметр марка: предсказано отсутствует, истина npks-8 (npk 8:20:30)",
        "Параметр марка: предсказано n7-p20-k30-s3, истина отсутствует",
        "Параметр стандарт: предсказано ту 2184-037-32496445-02, истина отсутствует",
        "Параметр количество вагонов: предсказано отсутствует, истина 15.0",
        "Параметр стандарт: предсказано отсутствует, истина ту 2181-073-05761695-2016",
        "Параметр масса нетто: предсказано отсутствует, истина 1035000.0",
        "Параметр стандарт: предсказано отсутствует, истина ту 20.15.71-031-00206486-2023",
        "Параметр марка: предсказано отсутствует, истина npk 16-16-16"
      ]
    }
  },
  "hyperparameters": {
    "max_new_tokens": 512,
    "model_name": "gemma-3-4b-it",
    "api_model": true,
    "multi_agent_mode": "simple_4agents"
  },
  "prompt_template": "build_prompt3",
  "prompt_full_text": "МУЛЬТИАГЕНТНЫЙ РЕЖИМ: simple_4agents\n\n================================================================================\nПРОМПТ 1: ИЗВЛЕЧЕНИЕ ЧИСЛОВЫХ ФРАГМЕНТОВ\n================================================================================\n\nТы — агент извлечения количественных атрибутов продукта из технического текста.\n\nТвоя задача — найти и извлечь все фрагменты текста, которые выражают\nизмеримые, нормируемые или спецификационные свойства продукта.\n\nИзвлекаемый фрагмент должен представлять собой:\n> «Сущность продукта + числовое значение + (при необходимости) единицы / допуск / стандарт»\n\nТо есть это должен быть осмысленный количественный атрибут, который может быть\nнормализован, сопоставлен и сравним в последующих шагах обработки.\n\n### ЧТО СЧИТАЕТСЯ АТРИБУТОМ\n\nИзвлекай фрагменты, описывающие:\n\n#### 1. Состав и концентрации\n- Массовые, молярные и процентные доли\n  (Азот 16%, P2O5 20%, содержание влаги не более 1.5%)\n- Формулы и марки удобрений\n  (N7-P20-K30-S3, 10-26-26)\n\n#### 2. Физические и логистические характеристики\n- Масса, объём, фасовка, упаковка\n  (мешки по 50 кг, биг-бэг 1000 кг, 25 л)\n- Плотность, насыпная масса, влажность и т.п.\n\n#### 3. Диапазоны, допуски, ограничения\n- ±, от…до…, не более, не менее, в пределах\n  (16% ±1%, от 6 до 12 г/л, не более 5%)\n\n#### 4. Нормативные числовые идентификаторы\n- ГОСТ, ТУ, ISO, EN и аналогичные стандарты с номерами\n\n### ЧТО НЕ ИЗВЛЕКАТЬ\n\nНе извлекай:\n- Даты, годы, номера партий\n- Телефоны, адреса, ИНН, артикулы\n- Позиционные номера, номера строк, страниц\n- Любые числа, не описывающие свойство продукта\n\n### ПРАВИЛА ИЗВЛЕЧЕНИЯ ФРАГМЕНТОВ\n\n1. Ты извлекаешь подстроки исходного текста, без перефразирования.\n2. Фрагмент должен быть минимальным, но семантически полным:\n   он должен включать:\n   - что измеряется\n   - и сколько\n3. Если рядом есть допуск или диапазон — включай его в тот же фрагмент:\n   правильно: «Азот 16% ±1%»  \n   неправильно: «Азот 16%» и «±1%» отдельно\n4. Если рядом несколько разных атрибутов — каждый извлекай отдельно.\n5. Если число относится к слову, оно должно быть извлечено вместе с этим словом:\n   правильно: «мешках по 50 кг»  \n   неправильно: «50 кг»\n\n### ПРИМЕР\n\nТекст:\nНИТРОАММОФОСКА, содержащая азот 16% ±1%, фосфор 16%, калий 16%, поставляется в мешках по 50 кг.\n\nПравильные фрагменты:\nАзот 16% ±1%\nФосфор 16%\nКалий 16%\nВ мешках по 50 кг\n\n### ТЕКСТ ДЛЯ АНАЛИЗА:\nКАЛИЙ СЕРНОКИСЛЫЙ ИЗ НЕФЕЛИНОВОГО СЫPЬЯ ТУ 20.15.52-089-05785164-2022, ПРЕДНАЗНАЧЕН ДЛЯ ПРИМЕНЕНИЯ В КАЧЕСТВЕ МИНЕРАЛЬНОГО УДОБРЕНИЯ В СЕЛЬСКОМ ХОЗЯЙСТВЕ, ПОЛУЧАЮТ ИЗ ВЕТВИ ТЕХНОЛОГИЧЕСКОГО ПРОЦЕССА ПРОИЗВОДСТВА СОДОПРОДУКТОВ ИЗ РАСТВОРОВ ГЛИНОЗЕМНОГО ПРОИЗВОДСТВА\n\n\n================================================================================\nПРОМПТ 2: ИЗВЛЕЧЕНИЕ МАССОВЫХ ДОЛЕЙ\n================================================================================\n\nТы — эксперт по извлечению массовых долей элементов из текстов об удобрениях.\n\nТвоя задача: из найденных числовых фрагментов извлечь только информацию о массовых долях химических элементов.\n\nМассовая доля может быть указана:\n- Прямо: \"массовая доля N 26%\", \"азот 16%\", \"N 26-28%\"\n- В марке: \"N7-P20-K30-S3\" означает N=7%, P2O5=20%, K2O=30%, S=3%\n- С операторами: \"не менее 10%\", \"не более 20%\"\n\nПравила:\n- Если указано \"МАССОВАЯ ДОЛЯ K В ПЕРЕСЧЕТЕ НА К2О\" - это \"массовая доля K2O\"\n- Если в марке указана доля - используй её, если нет прямого указания\n- Диапазоны указывай как [min, max]\n- Операторы: «не менее» - [min, null], «не более» - [null, max]\n- Названия элементов заменяй на химические обозначения (Кальций -> Ca)\n- Названия признаков пиши с маленькой буквы\n\nВыведи список найденных массовых долей в формате:\nвещество: значение (или [min, max] для диапазона)\nНапример:\nN: [16, 18]\n\nЕсли массовых долей нет, выведи \"Массовых долей не найдено\".\n\nЧисловые фрагменты для анализа:\n[Пример числовых фрагментов из предыдущего шага]\n\n\n================================================================================\nПРОМПТ 3: ИЗВЛЕЧЕНИЕ ПРОЧИХ ПАРАМЕТРОВ\n================================================================================\n\nТы — эксперт по извлечению прочих количественных параметров из текстов об удобрениях.\n\nТвоя задача: из найденных числовых фрагментов извлечь все параметры, КРОМЕ массовых долей элементов.\n\nИщи:\n- Массу нетто единицы (например, \"мешки по 50 кг\" -> масса нетто: 50 кг)\n- Массу брутто (масса с упаковкой)\n- Количество (мешков, поддонов, вагонов и др.)\n- Объем нетто единицы\n- Стандарты (ГОСТ, ТУ и др.)\n- Марки (если не использованы для массовых долей)\n\nПравила:\n- \"МЕШКИ ПО 50 КГ\" -> масса нетто: 50 кг\n- \"ПО 1000 КГ+5%\" -> масса брутто: 1050 кг\n- Для массы с упаковкой всегда \"масса брутто\"\n- Указывай единицы измерения (кроме \"марка\" и \"стандарт\")\n- Если параметра нет - не выводи его\n\nВыведи список найденных параметров в формате:\nпараметр: значение единица\n\nЕсли прочих параметров нет, выведи \"Прочих параметров не найдено\".\n\nЧисловые фрагменты для анализа:\n[Пример числовых фрагментов из предыдущего шага]\n\n\n================================================================================\nПРОМПТ 4: ФОРМИРОВАНИЕ JSON\n================================================================================\n\nТы агент, который формирует структурированный ответ в формате JSON.\n\n1. Объедини все массовые доли и прочие параметры в один JSON, строго по показанному образцу ниже.\n2. Если каких-то данных нет — выведи пустой список [] для этого поля.\n3. Все числа дай через точку, если есть десятичные.\n4. Для диапазона используй [min, max], [min, null] или [null, max].\n5. Для \"стандарт\" и \"марка\" используй поле \"значение\".\n6. Строго следуй названию каждого поля как в примере! Не добавляй ничего лишнего.\n\nПример ответа:\nОТВЕТ:\n```json\n{\n  \"массовая доля\": [\n    {\"вещество\": \"N\", \"массовая доля\": [26, 28]},\n    {\"вещество\": \"P2O5\", \"массовая доля\": [20, null]},\n    {\"вещество\": \"K2O\", \"массовая доля\": 20},\n    {\"вещество\": \"S\", \"массовая доля\": 3}\n  ],\n  \"прочее\": [\n    {\"параметр\": \"масса нетто единицы\", \"масса\": 50, \"единица\": \"кг\"},\n    {\"параметр\": \"масса брутто\", \"масса\": 1020, \"единица\": \"кг\"},\n    {\"параметр\": \"стандарт\", \"значение\": \"ТУ 2184-037-32496445-02\"},\n    {\"параметр\": \"марка\", \"значение\": \"N7-P20-K30-S3\"}\n  ]\n}\n\nВ начале обязательно выведи: ОТВЕТ:\n\nВозьми данные для заполнения json отсюда:\n\nМассовые доли:\n[Пример массовых долей из предыдущего шага]\n\nПрочие параметры:\n[Пример прочих параметров из предыдущего шага]\n\n",
  "prompt_info": {
    "mode": "simple_4agents",
    "prompts_used": [
      "NUMERIC_FRAGMENTS_EXTRACTION_PROMPT",
      "MASS_FRACTION_EXTRACTION_PROMPT",
      "OTHER_PARAMETERS_EXTRACTION_PROMPT",
      "JSON_FORMATION_PROMPT"
    ],
    "example_numeric_fragments_prompt": "\nТы — агент извлечения количественных атрибутов продукта из технического текста.\n\nТвоя задача — найти и извлечь все фрагменты текста, которые выражают\nизмеримые, нормируемые или спецификационные свойства продукта.\n\nИзвлекаемый фрагмент должен представлять собой:\n> «Сущность продукта + числовое значение + (при необходимости) единицы / допуск / стандарт»\n\nТо есть это должен быть осмысленный количественный атрибут, который может быть\nнормализован, сопоставлен и сравним в последующих шагах обработки.\n\n### ЧТО СЧИТАЕТСЯ АТРИБУТОМ\n\nИзвлекай фрагменты, описывающие:\n\n#### 1. Состав и концентрации\n- Массовые, молярные и процентные доли\n  (Азот 16%, P2O5 20%, содержание влаги не более 1.5%)\n- Формулы и марки удобрений\n  (N7-P20-K30-S3, 10-26-26)\n\n#### 2. Физические и логистические характеристики\n- Масса, объём, фасовка, упаковка\n  (мешки по 50 кг, биг-бэг 1000 кг, 25 л)\n- Плотность, насыпная масса, влажность и т.п.\n\n#### 3. Диапазоны, допуски, ограничения\n- ±, от…до…, не более, не менее, в пределах\n  (16% ±1%, от 6 до 12 г/л, не более 5%)\n\n#### 4. Нормативные числовые идентификаторы\n- ГОСТ, ТУ, ISO, EN и аналогичные стандарты с номерами\n\n### ЧТО НЕ ИЗВЛЕКАТЬ\n\nНе извлекай:\n- Даты, годы, номера партий\n- Телефоны, адреса, ИНН, артикулы\n- Позиционные номера, номера строк, страниц\n- Любые числа, не описывающие свойство продукта\n\n### ПРАВИЛА ИЗВЛЕЧЕНИЯ ФРАГМЕНТОВ\n\n1. Ты извлекаешь подстроки исходного текста, без перефразирования.\n2. Фрагмент должен быть минимальным, но семантически полным:\n   он должен включать:\n   - что измеряется\n   - и сколько\n3. Если рядом есть допуск или диапазон — включай его в тот же фрагмент:\n   правильно: «Азот 16% ±1%»  \n   неправильно: «Азот 16%» и «±1%» отдельно\n4. Если рядом несколько разных атрибутов — каждый извлекай отдельно.\n5. Если число относится к слову, оно должно быть извлечено вместе с этим словом:\n   правильно: «мешках по 50 кг»  \n   неправильно: «50 кг»\n\n### ПРИМЕР\n\nТекст:\nНИТРОАММОФОСКА, содержащая азот 16% ±1%, фосфор 16%, калий 16%, поставляется в мешках по 50 кг.\n\nПравильные фрагменты:\nАзот 16% ±1%\nФосфор 16%\nКалий 16%\nВ мешках по 50 кг\n\n### ТЕКСТ ДЛЯ АНАЛИЗА:\nКАЛИЙ СЕРНОКИСЛЫЙ ИЗ НЕФЕЛИНОВОГО СЫPЬЯ ТУ 20.15.52-089-05785164-2022, ПРЕДНАЗНАЧЕН ДЛЯ ПРИМЕНЕНИЯ В КАЧЕСТВЕ МИНЕРАЛЬНОГО УДОБРЕНИЯ В СЕЛЬСКОМ ХОЗЯЙСТВЕ, ПОЛУЧАЮТ ИЗ ВЕТВИ ТЕХНОЛОГИЧЕСКОГО ПРОЦЕССА ПРОИЗВОДСТВА СОДОПРОДУКТОВ ИЗ РАСТВОРОВ ГЛИНОЗЕМНОГО ПРОИЗВОДСТВА\n",
    "example_mass_fractions_prompt": "\nТы — эксперт по извлечению массовых долей элементов из текстов об удобрениях.\n\nТвоя задача: из найденных числовых фрагментов извлечь только информацию о массовых долях химических элементов.\n\nМассовая доля может быть указана:\n- Прямо: \"массовая доля N 26%\", \"азот 16%\", \"N 26-28%\"\n- В марке: \"N7-P20-K30-S3\" означает N=7%, P2O5=20%, K2O=30%, S=3%\n- С операторами: \"не менее 10%\", \"не более 20%\"\n\nПравила:\n- Если указано \"МАССОВАЯ ДОЛЯ K В ПЕРЕСЧЕТЕ НА К2О\" - это \"массовая доля K2O\"\n- Если в марке указана доля - используй её, если нет прямого указания\n- Диапазоны указывай как [min, max]\n- Операторы: «не менее» - [min, null], «не более» - [null, max]\n- Названия элементов заменяй на химические обозначения (Кальций -> Ca)\n- Названия признаков пиши с маленькой буквы\n\nВыведи список найденных массовых долей в формате:\nвещество: значение (или [min, max] для диапазона)\nНапример:\nN: [16, 18]\n\nЕсли массовых долей нет, выведи \"Массовых долей не найдено\".\n\nЧисловые фрагменты для анализа:\n[Пример числовых фрагментов]\n",
    "example_other_parameters_prompt": "\nТы — эксперт по извлечению прочих количественных параметров из текстов об удобрениях.\n\nТвоя задача: из найденных числовых фрагментов извлечь все параметры, КРОМЕ массовых долей элементов.\n\nИщи:\n- Массу нетто единицы (например, \"мешки по 50 кг\" -> масса нетто: 50 кг)\n- Массу брутто (масса с упаковкой)\n- Количество (мешков, поддонов, вагонов и др.)\n- Объем нетто единицы\n- Стандарты (ГОСТ, ТУ и др.)\n- Марки (если не использованы для массовых долей)\n\nПравила:\n- \"МЕШКИ ПО 50 КГ\" -> масса нетто: 50 кг\n- \"ПО 1000 КГ+5%\" -> масса брутто: 1050 кг\n- Для массы с упаковкой всегда \"масса брутто\"\n- Указывай единицы измерения (кроме \"марка\" и \"стандарт\")\n- Если параметра нет - не выводи его\n\nВыведи список найденных параметров в формате:\nпараметр: значение единица\n\nЕсли прочих параметров нет, выведи \"Прочих параметров не найдено\".\n\nЧисловые фрагменты для анализа:\n[Пример числовых фрагментов]\n",
    "example_json_formation_prompt": "\nТы агент, который формирует структурированный ответ в формате JSON.\n\n1. Объедини все массовые доли и прочие параметры в один JSON, строго по показанному образцу ниже.\n2. Если каких-то данных нет — выведи пустой список [] для этого поля.\n3. Все числа дай через точку, если есть десятичные.\n4. Для диапазона используй [min, max], [min, null] или [null, max].\n5. Для \"стандарт\" и \"марка\" используй поле \"значение\".\n6. Строго следуй названию каждого поля как в примере! Не добавляй ничего лишнего.\n\nПример ответа:\nОТВЕТ:\n```json\n{\n  \"массовая доля\": [\n    {\"вещество\": \"N\", \"массовая доля\": [26, 28]},\n    {\"вещество\": \"P2O5\", \"массовая доля\": [20, null]},\n    {\"вещество\": \"K2O\", \"массовая доля\": 20},\n    {\"вещество\": \"S\", \"массовая доля\": 3}\n  ],\n  \"прочее\": [\n    {\"параметр\": \"масса нетто единицы\", \"масса\": 50, \"единица\": \"кг\"},\n    {\"параметр\": \"масса брутто\", \"масса\": 1020, \"единица\": \"кг\"},\n    {\"параметр\": \"стандарт\", \"значение\": \"ТУ 2184-037-32496445-02\"},\n    {\"параметр\": \"марка\", \"значение\": \"N7-P20-K30-S3\"}\n  ]\n}\n\nВ начале обязательно выведи: ОТВЕТ:\n\nВозьми данные для заполнения json отсюда:\n\nМассовые доли:\n[Пример массовых долей]\n\nПрочие параметры:\n[Пример прочих параметров]\n"
  },
  "parsing_errors": [
    "Текст #0: ошибка в мультиагентном подходе. Ошибка: Agents 2 and 3 returned empty responses",
    "Текст #1: ошибка в мультиагентном подходе. Ошибка: Agents 2 and 3 returned empty responses",
    "Текст #4: невалидный JSON. Ответ: {\n  \"массовая доля\": [],\n  \"прочее\": [\n    {\"параметр\": \"количество\", \"масса\": 15, \"единица\": \"вагонов\"},\n    {\"параметр\": \"масса брутто\", \"масса\": 1035000.00, \"единица\": \"кг\"},\n    {\"параметр\": \"стандарт\", \"значение\": \"\"},\n    {\"параметр\": \"марка\", \"значение\": \"\"}\n  ]\n}",
    "Текст #15: ошибка в мультиагентном подходе. Ошибка: Agents 2 and 3 returned empty responses",
    "Текст #17: ошибка в мультиагентном подходе. Ошибка: Agents 2 and 3 returned empty responses",
    "Текст #18: невалидный JSON. Ответ: {\n  \"массовая доля\": [],\n  \"прочее\": [\n    {\"параметр\": \"масса брутто\", \"масса\": 20980, \"единица\": \"кг\"},\n    {\"параметр\": \"стандарт\", \"значение\": \"\"},\n    {\"параметр\": \"марка\", \"значение\": \"\"}\n  ]\n}",
    "Текст #27: невалидный JSON. Ответ: {\n  \"массовая доля\": [\n    {\"вещество\": \"N\", \"массовая доля\": [15.5, 15.5]}\n  ],\n  \"прочее\": [\n    {\"параметр\": \"масса нетто единицы\", \"масса\": 25, \"единица\": \"кг\"},\n    {\"параметр\": \"стандарт\", \"значение\": \"\"},\n    {\"параметр\": \"марка\", \"значение\": \"\"}\n  ]\n}",
    "Текст #32: невалидный JSON. Ответ: {\n  \"массовая доля\": [],\n  \"прочее\": [\n    {\"параметр\": \"масса брутто\", \"масса\": 1000, \"единица\": \"кг\"},\n    {\"параметр\": \"стандарт\", \"значение\": \"\"},\n    {\"параметр\": \"марка\", \"значение\": \"\"}\n  ]\n}",
    "Текст #33: ошибка в мультиагентном подходе. Ошибка: Agents 2 and 3 returned empty responses",
    "Текст #36: невалидный JSON. Ответ: {\n  \"массовая доля\": [],\n  \"прочее\": [\n    {\"параметр\": \"количество\", \"единица\": \"кг\", \"масса\": 22000.00},\n    {\"параметр\": \"стандарт\", \"значение\": \"\"},\n    {\"параметр\": \"марка\", \"значение\": \"\"}\n  ]\n}",
    "Текст #46: невалидный JSON. Ответ: {\n  \"массовая доля\": [],\n  \"прочее\": [\n    {\"параметр\": \"количество\", \"единица\": \"кг\", \"масса\": 22000.00},\n    {\"параметр\": \"стандарт\", \"значение\": \"\"},\n    {\"параметр\": \"марка\", \"значение\": \"\"}\n  ]\n}",
    "Текст #51: ошибка в мультиагентном подходе. Ошибка: Agents 2 and 3 returned empty responses",
    "Текст #55: невалидный JSON. Ответ: {\n  \"массовая доля\": [],\n  \"прочее\": [\n    {\"параметр\": \"масса брутто\", \"масса\": 6000, \"единица\": \"кг\"},\n    {\"параметр\": \"количество\", \"масса\": 300, \"единица\": \"меш.\"},\n    {\"параметр\": \"масса нетто\", \"масса\": 20, \"единица\": \"кг\"},\n    {\"параметр\": \"масса нетто\", \"масса\": 162, \"единица\": \"кг\"},\n    {\"параметр\": \"стандарт\", \"значение\": \"\"},\n    {\"параметр\": \"марка\", \"значение\": \"\"}\n  ]\n}",
    "Текст #56: ошибка в мультиагентном подходе. Ошибка: Agents 2 and 3 returned empty responses",
    "Текст #58: невалидный JSON. Ответ: {\n  \"массовая доля\": [],\n  \"прочее\": [\n    {\"параметр\": \"масса нетто единицы\", \"масса\": 470, \"единица\": \"кг\"},\n    {\"параметр\": \"масса брутто\", \"масса\": 9.4, \"единица\": \"кг\"},\n    {\"параметр\": \"количество\", \"масса\": 50, \"единица\": \"единиц\"},\n    {\"параметр\": \"количество\", \"масса\": 1, \"единица\": \"единиц\"},\n    {\"параметр\": \"стандарт\", \"значение\": \"\"},\n    {\"параметр\": \"марка\", \"значение\": \"\"}\n  ]\n}",
    "Текст #61: невалидный JSON. Ответ: {\n  \"массовая доля\": [\n    {\"вещество\": \"N\", \"массовая доля\": [16.4, null]}\n  ],\n  \"прочее\": [\n    {\"параметр\": \"масса нетто единицы\", \"масса\": 25, \"единица\": \"кг\"},\n    {\"параметр\": \"количество мешков\", \"масса\": 880},\n    {\"параметр\": \"количество поддонов\", \"масса\": 22},\n    {\"параметр\": \"стандарт\", \"значение\": \"\"},\n    {\"параметр\": \"марка\", \"значение\": \"\"}\n  ]\n}",
    "Текст #70: невалидный JSON. Ответ: {\n  \"массовая доля\": [\n    {\"вещество\": \"N\", \"массовая доля\": [5.6, null]},\n    {\"вещество\": \"P2O5\", \"массовая доля\": [17.5, null]},\n    {\"вещество\": \"K2O\", \"массовая доля\": [34.0, null]},\n    {\"вещество\": \"вода\", \"массовая доля\": [0, 1.6]},\n    {\"вещество\": \"S\", \"массовая доля\": [2.3, null]}\n  ],\n  \"прочее\": [\n    {\"параметр\": \"Количество\", \"масса\": 100, \"единица\": \"%\"},\n    {\"параметр\": \"стандарт\", \"значение\": \"5.3\"},\n    {\"параметр\": \"марка\", \"значение\": \"\"}\n  ]\n}",
    "Текст #72: ошибка в мультиагентном подходе. Ошибка: Agents 2 and 3 returned empty responses",
    "Текст #73: невалидный JSON. Ответ: {\n  \"массовая доля\": [],\n  \"прочее\": [\n    {\"параметр\": \"масса нетто единицы\", \"масса\": 20, \"единица\": \"кг\"},\n    {\"параметр\": \"масса брутто\", \"масса\": 105, \"единица\": \"кг\"},\n    {\"параметр\": \"количество\", \"масса\": 150, \"единица\": \"П/Э меш.\"},\n    {\"параметр\": \"объем нетто единицы\", \"масса\": 30, \"единица\": \"кг\"},\n    {\"параметр\": \"количество\", \"масса\": 3, \"единица\": \"поддона\"},\n    {\"параметр\": \"масса брутто\", \"масса\": 105, \"единица\": \"кг\"},\n    {\"параметр\": \"стандарт\", \"значение\": \"\"},\n    {\"параметр\": \"марка\", \"значение\": \"\"}\n  ]\n}",
    "Текст #74: ошибка в мультиагентном подходе. Ошибка: Agents 2 and 3 returned empty responses",
    "Текст #75: невалидный JSON. Ответ: {\n  \"массовая доля\": [],\n  \"прочее\": [\n    {\"параметр\": \"масса нетто единицы\", \"масса\": 50, \"единица\": \"кг\"},\n    {\"параметр\": \"масса брутто\", \"масса\": 1020, \"единица\": \"кг\"},\n    {\"параметр\": \"стандарт\", \"значение\": \"\"},\n    {\"параметр\": \"марка\", \"значение\": \"\"}\n  ]\n}",
    "Текст #76: невалидный JSON. Ответ: {\n  \"массовая доля\": [],\n  \"прочее\": [\n    {\"параметр\": \"масса брутто\", \"масса\": 1000, \"единица\": \"кг\"},\n    {\"параметр\": \"стандарт\", \"значение\": \"\"},\n    {\"параметр\": \"марка\", \"значение\": \"\"}\n  ]\n}",
    "Текст #81: ошибка в мультиагентном подходе. Ошибка: Agents 2 and 3 returned empty responses",
    "Текст #85: невалидный JSON. Ответ: {\n  \"массовая доля\": [],\n  \"прочее\": [\n    {\"параметр\": \"масса нетто единицы\", \"масса\": 25, \"единица\": \"кг\"},\n    {\"параметр\": \"масса брутто\", \"масса\": 21540, \"единица\": \"кг\"},\n    {\"параметр\": \"стандарт\", \"значение\": \"\"},\n    {\"параметр\": \"марка\", \"значение\": \"\"}\n  ]\n}",
    "Текст #91: ошибка в мультиагентном подходе. Ошибка: Agents 2 and 3 returned empty responses",
    "Текст #92: невалидный JSON. Ответ: {\n  \"массовая доля\": [\n    {\"вещество\": \"N\", \"массовая доля\": [16, 18]},\n    {\"вещество\": \"Ca\", \"массовая доля\": [14, 15]}\n  ],\n  \"прочее\": [\n    {\"параметр\": \"количество\", \"единица\": \"кг\", \"масса\": 25},\n    {\"параметр\": \"стандарт\": []},\n    {\"параметр\": \"марка\": []}\n  ]\n}",
    "Текст #99: невалидный JSON. Ответ: {\n  \"массовая доля\": [],\n  \"прочее\": [\n    {\"параметр\": \"масса нетто единицы\", \"масса\": 25, \"единица\": \"кг\"},\n    {\"параметр\": \"количество\", \"масса\": 800, \"единица\": \"кг\"},\n    {\"параметр\": \"стандарт\", \"значение\": \"\"},\n    {\"параметр\": \"марка\", \"значение\": \"\"}\n  ]\n}"
  ],
  "total_samples": 100,
  "valid_json_count": 73,
  "invalid_json_count": 27,
  "gemini_analysis": {
    "status": "success",
    "analysis": "Как эксперт по оценке качества работы языковых моделей, я провел анализ предоставленных результатов тестирования модели `gemma-3-4b-it`.\n\nОбщее впечатление: Производительность модели крайне низка для данной задачи, о чем свидетельствуют очень низкие значения метрик Precision, Recall и F1. Это указывает на серьезные проблемы как с извлечением релевантной информации, так и с формированием корректного вывода.\n\n---\n\n### 1. Характерные ошибки модели\n\n1.  **Катастрофически низкие метрики:** F1-метрики 10.87% и 19.42% указывают на то, что модель фактически не справляется с задачей. Это не мелкие недочеты, а фундаментальная неспособность выполнять поставленную задачу извлечения с требуемой точностью и полнотой.\n2.  **Проблемы с JSON-форматом:** Значительное количество (27 ошибок из неизвестного общего числа текстов) ошибок парсинга JSON. Модель неспособна стабильно генерировать валидный JSON, часто выдавая неполные объекты (`{`) или некорректно структурированные данные.\n3.  **Ошибки в мультиагентном подходе:** Ошибки типа \"Agents 2 and 3 returned empty responses\" являются критическими и указывают на сбой в координации или выполнении задач отдельных агентов. Это может быть как проблемой самого мультиагентного фреймворка, так и неспособностью агентов генерировать ожидаемый контент.\n4.  **Высокий уровень пропусков (False Negatives - низкий Recall):** Примеры ошибок качества показывают, что модель часто *вообще не извлекает* требуемые атрибуты (\"предсказано отсутствует, истина [значение]\"). Это говорит о том, что модель либо не распознает сущности, либо ошибочно отфильтровывает их.\n5.  **Высокий уровень ошибочных извлечений (False Positives - низкий Precision):** Примеры, где \"истина отсутствует\" (например, `марка: предсказано n7-p20-k30-s3, истина отсутствует` или `стандарт: предсказано ту 2184-037-32496445-02, истина отсутствует`), показывают, что модель генерирует информацию, которая либо не присутствует в тексте, либо не соответствует требуемому типу атрибута.\n\n---\n\n### 2. Причины ошибок парсинга JSON\n\nОсновные причины ошибок парсинга JSON:\n\n1.  **Отсутствие явного примера JSON-схемы в промпте:** Хотя в промпте хорошо описано *что* извлекать, нет *конкретного примера* желаемой структуры JSON (full-shot example). Модели часто \"додумывают\" структуру, что приводит к вариативности и ошибкам.\n2.  **Сложность целевого JSON-формата:** Формат с вложенными списками объектов (`\"массовая доля\": [...]`, `\"прочее\": [...]`) и разными ключами внутри них (`вещество`, `массовая доля` / `параметр`, `масса`, `единица`, `значение`) сложен для небольших моделей без явных примеров.\n3.  **Ограничения модели `gemma-3-4b-it`:** Модель Gemma-3.4B является относительно небольшой. Генерация строго структурированных данных, таких как JSON, требует высокой точности и способности следовать сложным инструкциям, что может быть затруднительно для моделей такого размера без дополнительной доводки.\n4.  **Возможное влияние мультиагентного режима:** Если несколько агентов вносят свой вклад в финальный JSON или если есть этап агрегации/консолидации, то проблемы на любом из этих этапов могут приводить к невалидному JSON. Ошибки типа \"Agents 2 and 3 returned empty responses\" могут влиять на финальную структуру.\n5.  **Неоднозначность в заполнении полей:** Например, если атрибут отсутствует, должен ли быть пустой список, пустая строка в значении или ключ должен отсутствовать? Модель, возможно, не знает, как себя вести в таких случаях, и генерирует `{\"параметр\": \"стандарт\", \"значение\": \"\"}` вместо, например, полного отсутствия этого объекта, если стандарт не найден.\n\n---\n\n### 3. Причины ошибок в извлечении данных\n\n1.  **Проблемы с мультиагентным режимом:** Это самая вероятная и критическая причина. Если \"Agents 2 and 3 returned empty responses\", это может означать, что основные данные для обработки не доходят до агента извлечения, или что результаты этого агента не агрегируются должным образом. Непонятно, какую роль выполняет именно этот промпт в контексте \"simple_4agents\". Если это промпт для *одного* из агентов, а другие агенты не выполняют свою работу, это прямо влияет на полноту и точность извлечения.\n2.  **Недостаточная \"сила\" модели для задачи:** `gemma-3-4b-it` может быть просто недостаточно мощной для столь детализированной и точной задачи извлечения информации из технических текстов, требующей глубокого понимания контекста и специфичных паттернов.\n3.  **Недостаточное количество или качество примеров в промпте:** Хотя промпт детален, он в основном описывает *правила*. LLM-модели часто лучше учатся на *конкретных примерах* (few-shot learning) \"входной текст -> желаемый JSON-вывод\", чем на декларативных правилах. Отсутствие таких примеров может быть причиной низкого Recall.\n4.  **Сложность распознавания количественных атрибутов:** Модели сложно отличить \"Азот 16%\" от \"Партия 16\" без очень сильных примеров и указаний. Несмотря на раздел \"ЧТО НЕ ИЗВЛЕКАТЬ\", модель все равно может путаться.\n5.  **Расплывчатость некоторых категорий:** Например, `марка удобрений` указана в разделе \"1. Состав и концентрации\", но в ошибках фигурирует как \"прочее\". Такое несоответствие может сбивать модель.\n\n---\n\n### 4. Рекомендации по улучшению промпта\n\n1.  **Добавить явный JSON-схему и примеры вывода (Most Critical):**\n    *   После инструкций \"ПРАВИЛА ИЗВЛЕЧЕНИЯ ФРАГМЕНТОВ\" добавьте раздел \"ФОРМАТ ВЫХОДА\" или \"ПРИМЕР ВЫХОДА\".\n    *   Предоставьте 1-2 полных примера входного текста и соответствующего *валидного* JSON-вывода, который охватывает оба типа категорий (`массовая доля` и `прочее`) и различные вариации значений (диапазоны, единичные значения, стандарты).\n    *   **Пример:**\n        ```json\n        {\n          \"массовая доля\": [\n            {\"вещество\": \"N\", \"значение\": 16.0, \"допуск\": \"±1%\"},\n            {\"вещество\": \"P2O5\", \"диапазон\": [19.0, 21.0]},\n            {\"вещество\": \"K2O\", \"значение\": 50.0}\n          ],\n          \"прочее\": [\n            {\"параметр\": \"масса нетто единицы\", \"значение\": 50, \"единица\": \"кг\"},\n            {\"параметр\": \"стандарт\", \"значение\": \"ГОСТ Р 52189-2003\"},\n            {\"параметр\": \"марка\", \"значение\": \"N7-P20-K30-S3\"}\n          ]\n        }\n        ```\n    *   Четко прописать, как обрабатывать отсутствие атрибутов: нужно ли опускать ключ или использовать `null`. Рекомендую опускать ключ или объект, если атрибут не найден.\n\n2.  **Усилить инструкции по форматированию JSON:**\n    *   Добавить фразу: \"Твой ответ должен быть *строго* в формате JSON-объекта, содержащего ключи `массовая доля` и `прочее`, значениями которых являются списки объектов. Никакого дополнительного текста.\"\n    *   Указать, что если атрибутов нет, то списки должны быть пустыми: `\"массовая доля\": [], \"прочее\": []`.\n\n3.  **Уточнить определения категорий:**\n    *   Если \"марка удобрений\" должна быть в \"прочем\", явно вынести ее туда в описание: \"#### 5. Идентификация и маркировка: Марки удобрений (N7-P20-K30-S3)\".\n    *   Четко разграничить, какие числовые значения относятся к `массовая доля` (состав, концентрации) и какие к `прочее` (физические, логистические, нормативные).\n\n4.  **Повторить правило извлечения подстрок:** После примера JSON еще раз напомнить: \"Помни: извлекай подстроки исходного текста, без перефразирования.\"\n\n5.  **Конкретизировать роли в мультиагентном режиме (если это промпт для одного агента):**\n    *   Если этот промпт предназначен для одного из агентов (например, \"Агент 1: Извлечение количественных атрибутов\"), четко описать его входные данные (сырой текст) и ожидаемые выходные данные (JSON) в рамках *всей* системы.\n    *   Например: \"Ты — Агент 1 в мультиагентной системе. Твоя задача — получить сырой технический текст продукта и извлечь из него все количественные атрибуты в формате JSON, который затем будет передан для обработки следующему агенту.\"\n\n---\n\n### 5. Рекомендации по настройке гиперпараметров\n\n1.  **Мультиагентный режим (`multi_agent_mode`): ИЗУЧИТЬ или ВЫКЛЮЧИТЬ.**\n    *   Это ключевой источник проблем. Ошибки \"Agents 2 and 3 returned empty responses\" указывают на то, что система не работает корректно.\n    *   **Вариант А (Изучить):** Если мультиагентный подход является неотъемлемой частью архитектуры, необходимо глубоко проанализировать:\n        *   Промпты для *всех* агентов.\n        *   Логику взаимодействия и передачи данных между агентами.\n        *   Механизмы агрегации их ответов.\n        *   Причины, по которым агенты 2 и 3 возвращают пустые ответы. Возможно, им не хватает контекста, или их промпты неясны.\n    *   **Вариант Б (Выключить/Упростить):** Если это возможно, попробуйте временно отключить мультиагентный режим и запускать задачу с *одним агентом*, используя весь предоставленный промпт. Это позволит изолировать проблемы самой модели Gemma от проблем координации агентов. Если модель начнет давать более валидный JSON, значит, проблема в мультиагентной оркестрации.\n2.  **`max_new_tokens`: Оставить 512.** Это разумное значение для данной задачи. Увеличение может потребоваться только если извлекаемый JSON будет очень объемным, что маловероятно для извлечения атрибутов из одного документа.\n3.  **`model_name`: Рассмотреть более мощные модели.** Если после всех улучшений промпта и решения проблем с мультиагентным режимом `gemma-3-4b-it` все еще показывает низкие метрики, то стоит попробовать более мощные модели (например, Gemma-7B-it, Llama 3 8B-it или Mistral 7B Instruct). Gemma-3.4B может быть просто недостаточно способной для такой специфичной и точной задачи.\n\n---\n\n### 6. Общие рекомендации по улучшению качества\n\n1.  **Итеративное улучшение промпта:** Внедрите предложенные изменения в промпт, проведите повторное тестирование, проанализируйте новые ошибки и снова скорректируйте промпт. Это циклический процесс.\n2.  **Пост-обработка и валидация:**\n    *   Внедрите строгую валидацию JSON на стороне клиента или в пост-процессинге. Если JSON невалиден, логируйте ошибку и попробуйте простейшие исправления (например, добавить закрывающую скобку, если ее не хватает).\n    *   Разработайте правила для очистки и нормализации извлеченных данных (например, приведение единиц измерения, обработка диапазонов).\n    *   Отфильтруйте \"пустые\" или явно некорректные извлечения (например, `значение: \"\"`).\n3.  **Сбор и анализ ошибок:** Продолжайте собирать примеры ошибок (как JSON-парсинга, так и качества извлечения). Классифицируйте их, чтобы выявить наиболее частые паттерны, которые можно устранить через промптинг или, в перспективе, через дообучение.\n4.  **Дообучение (Fine-tuning):** Если задача является критичной и объем данных достаточно велик, лучшим решением для достижения высокой точности и F1-метрики будет дообучение (fine-tuning) модели на собственном датасете извлеченных атрибутов. Для `gemma-3-4b` это вполне осуществимо.\n5.  **Оцените необходимость мультиагентного подхода:** Если мультиагентный режим не дает явных преимуществ и является источником ошибок, рассмотрите возможность его полной отмены и решения задачи одним, хорошо промптированным агентом.\n6.  **Проверка исходных данных:** Убедитесь, что исходные тексты, которые подаются модели, соответствуют ожиданиям. Иногда проблемы могут быть вызваны \"грязными\" или неожиданными входными данными.\n\n---\n\nС учетом крайне низких метрик, я бы начал с **решения проблем мультиагентного режима** (попробовать отключить или глубоко дебажить) и **добавления явных JSON-примеров** в промпт. Эти два пункта, скорее всего, дадут наиболее значительный прирост в качестве.",
    "model_used": "gemini-2.5-flash"
  }
}