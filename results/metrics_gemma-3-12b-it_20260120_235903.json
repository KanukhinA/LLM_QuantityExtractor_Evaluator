{
  "timestamp": "20260120_235903",
  "model_name": "gemma-3-12b-it",
  "interrupted": false,
  "processed_count": 100,
  "total_count": 100,
  "multi_agent_mode": null,
  "gpu_info": {
    "api": true
  },
  "gpu_memory_after_load_gb": 0.0,
  "gpu_memory_during_inference_gb": 0.0,
  "gpu_memory_during_inference_max_gb": 0.0,
  "gpu_memory_during_inference_min_gb": 0.0,
  "api_model": true,
  "average_response_time_seconds": 20.90183225393295,
  "parsing_error_rate": 0.09,
  "parsing_errors_count": 9,
  "quality_metrics": {
    "массовая доля": {
      "средняя_точность": 0.5959477075954349,
      "precision": 0.7415254237288136,
      "recall": 0.691699604743083,
      "f1": 0.7157464212678938,
      "tp": 175,
      "fp": 61,
      "fn": 78,
      "ошибки": [
        "Вещество CI: предсказано [1.0, 2.0], истина отсутствует",
        "Вещество Cl: предсказано отсутствует, истина 1.0",
        "Вещество NH4-N: предсказано [None, 0.5], истина отсутствует",
        "Вещество N: предсказано [17.0, None], истина 17.0",
        "Вещество NH4+: предсказано отсутствует, истина [None, 0.5]",
        "Вещество нерастворимого остатка: предсказано отсутствует, истина [None, 0.03]",
        "Вещество P2O5: предсказано [20.0, 21.0], истина [19.0, 21.0]",
        "Вещество N: предсказано [20.0, 21.0], истина [19.0, 21.0]",
        "Вещество S: предсказано [14.0, 15.0], истина [13.0, 15.0]",
        "Вещество частиц < 1 мм: предсказано отсутствует, истина 0.0"
      ]
    },
    "прочее": {
      "средняя_точность": 0.3716588966588966,
      "precision": 0.5182926829268293,
      "recall": 0.4187192118226601,
      "f1": 0.4632152588555858,
      "tp": 85,
      "fp": 79,
      "fn": 118,
      "ошибки": [
        "Параметр марка: предсказано npks-8, истина npks-8 (npk 8:20:30)",
        "Параметр масса нетто: предсказано отсутствует, истина 1035000.0",
        "Параметр масса: предсказано 1035000.0, истина отсутствует",
        "Параметр масса нетто единицы: предсказано отсутствует, истина 50.0",
        "Параметр масса нетто: предсказано 50.0, истина отсутствует",
        "Параметр масса нетто единицы: предсказано отсутствует, истина 20.0",
        "Параметр количество мешков: предсказано отсутствует, истина 1000.0",
        "Параметр масса нетто: предсказано 20.0, истина 20000.0",
        "Параметр масса стрейч-пленки: предсказано отсутствует, истина 540.0",
        "Параметр марка: предсказано отсутствует, истина а"
      ]
    }
  },
  "hyperparameters": {
    "max_new_tokens": 512,
    "model_name": "gemma-3-12b-it",
    "api_model": true
  },
  "prompt_template": "build_prompt3",
  "prompt_full_text": "\nТы — эксперт по извлечению численных и количественных характеристик из текстов о химических веществах и удобрениях.  \nТвоя задача:  \n\n1. Найти все численные признаки в тексте, например:  \n   - Массовую долю элементов (массовая доля N, массовая доля P2O5 и др.) в процентах.  \n   - Количество товара (кг, т, п/э мешки, вагон и др.).  \n   - Прочие численные показатели, указанные в тексте (марки, стандарты (ТУ, ГОСТ и др.), идентификаторы).  \n\n2. Для каждого численного признака определить:  \n   - Название признака (например, \"массовая доля N\", \"массовая доля P2O5\", \"массовая доля К2О\", \"массовая доля S\", \"масса нетто единицы\", \"масса нетто\", \"масса K2O\", \"масса брутто\", \"количество вагонов\", \"стандарт\" и т.д.)  \n   - Значение (число, если есть диапазон — брать оба значения; для стандарта указываешь полный номер стандарта со словами ГОСТ/ТУ или др.)  \n   - Единицу измерения (%, кг, т, шт, п/э меш, вагон, или пусто для стандарта)  \n\n3. Особые указания:\n   - Извлекай на русском\n   - Если признак указан как диапазон из нескольких чисел (например \"8-10\", или \"от 6 до 12\") или с погрешностью (+/-), укажи оба числа в формате [min, max]. \n   - Извлекай логические/сравнительные операторы, если они присутствуют в тексте: «не менее» - [min, null] «не более» - [null, max]\n   - Используй точку в качестве разделителя десятичных чисел.\n   - Название вещества и его массовая доля могут встречаться в марке (например, \"N7-P20-K30-S3\"),  используй данные из марки, если нет иных данных по массовой доле вещества.\n   - Если в названии признака есть название химического элемента (например Кальций) - замени его на обозначение химического элемента - Ca.\n   - Названия признаков пиши с маленькой буквы. Например \"массовая доля Zn\".\n   - Если указано например \"МАССОВАЯ ДОЛЯ K В ПЕРЕСЧЕТЕ НА К2О\" - то правильным извлекаемым признаком будет \"массовая доля K2O\".\n   - Если один и тот же параметр встречается дважды — сначала как общее условие (например, «с содержанием азота более 10%»), а затем как конкретное значение (например, «азот 16%»), указывай только конкретное значение.\n   - Для массы с упаковкой - называй признак \"масса брутто\" вне зависимости от наименования упаковки. Если указывается просто масса в формате \"МЕШКИ ПО 50 КГ\" - это признак \"масса нетто\".\n   - Если дается масса в виде \"ПО 1000 КГ+5%\" - указывай в признаке \"масса брутто\" одно значение - 1050.\n   - Для прочих признаков (всех признаков, помимо \"массовой доли\") указывай единицы измерения (за исключением признаков \"марка\" и \"стандарт\")\n   - Если признака в тексте нет - не извлекай его и не выводи его в json.\n\n4. Выводи строго JSON следующего вида (пример):\n\nПример текста:\nНИТРОАММОФОСКА, УДОБРЕНИЕ МИНЕРАЛЬНОЕ, СОДЕРЖАЩЕЕ ТРИ ПИТАТЕЛЬНЫХ ЭЛЕМЕНТА - АЗОТ-27 +-1%, ФОСФОР-20% (В ПЕРЕСЧЕТЕ НА P2O5), КАЛИЙ-20% (В ПЕРЕСЧЕТЕ НА K2O), СЕРА-3%. ПОСТАВЛЯЕТСЯ В МЕШКАХ ПО 50 КГ. МАССА БРУТТО С УПАКОВКОЙ: 1020 КГ. КОЛИЧЕСТВО ПОДДОНОВ: 20 ШТ. КОЛИЧЕСТВО МЕШКОВ: 1000 ШТ. ОБЪЕМ НЕТТО ЕДИНИЦЫ: 10 Л. СООТВЕТСТВУЕТ ТУ 2184-037-32496445-02. МАРКА: N26-P20-K20-S3.\n\nПример ответа:\n```json\n{\n  \"массовая доля\": [\n    {\"вещество\": \"N\", \"массовая доля\": [26, 28]},\n    {\"вещество\": \"P2O5\", \"массовая доля\": 20},\n    {\"вещество\": \"K2O\", \"массовая доля\": 20},\n    {\"вещество\": \"S\", \"массовая доля\": 3}\n  ],\n  \"прочее\": [\n    {\"параметр\": \"масса нетто единицы\", \"масса\": 50, \"единица\": \"кг\"},\n    {\"параметр\": \"масса брутто\", \"масса\": 1020, \"единица\": \"кг\"},\n    {\"параметр\": \"количество поддонов\", \"количество\": 20, \"единица\": \"шт\"},\n    {\"параметр\": \"количество мешков\", \"количество\": 1000, \"единица\": \"шт\"},\n    {\"параметр\": \"объем нетто единицы\", \"объем\": 10, \"единица\": \"л\"},\n    {\"параметр\": \"стандарт\", \"значение\": \"ТУ 2184-037-32496445-02\"},\n    {\"параметр\": \"марка\", \"значение\": \"N26-P20-K20-S3\"}\n  ]\n}\n```\n\n5. Выводи json результат **только после слова ОТВЕТ:**.\n\nТекст для анализа:\nКАЛИЙ СЕРНОКИСЛЫЙ ИЗ НЕФЕЛИНОВОГО СЫPЬЯ ТУ 20.15.52-089-05785164-2022, ПРЕДНАЗНАЧЕН ДЛЯ ПРИМЕНЕНИЯ В КАЧЕСТВЕ МИНЕРАЛЬНОГО УДОБРЕНИЯ В СЕЛЬСКОМ ХОЗЯЙСТВЕ, ПОЛУЧАЮТ ИЗ ВЕТВИ ТЕХНОЛОГИЧЕСКОГО ПРОЦЕССА ПРОИЗВОДСТВА СОДОПРОДУКТОВ ИЗ РАСТВОРОВ ГЛИНОЗЕМНОГО ПРОИЗВОДСТВА\n",
  "prompt_info": null,
  "parsing_errors": [
    "Текст #11: невалидный JSON. Ответ: ",
    "Текст #20: невалидный JSON. Ответ: ",
    "Текст #34: невалидный JSON. Ответ: ",
    "Текст #43: невалидный JSON. Ответ: ",
    "Текст #65: невалидный JSON. Ответ: ",
    "Текст #72: невалидный JSON. Ответ: ",
    "Текст #78: невалидный JSON. Ответ: ",
    "Текст #82: невалидный JSON. Ответ: ",
    "Текст #92: невалидный JSON. Ответ: "
  ],
  "total_samples": 100,
  "valid_json_count": 91,
  "invalid_json_count": 9,
  "gemini_analysis": {
    "status": "success",
    "analysis": "## Анализ результатов тестирования модели gemma-3-12b-it\n\nМодель `gemma-3-12b-it` демонстрирует умеренную эффективность в задаче извлечения численных и количественных характеристик, особенно для категории \"Массовая доля\". Однако, существуют значительные проблемы с извлечением \"Прочих\" параметров и критические ошибки с форматированием вывода JSON.\n\n### 1. Характерные ошибки модели\n\n*   **Низкая точность и полнота для \"Прочих\" параметров:** F1-метрика 46.32% указывает на серьезные проблемы как с идентификацией всех необходимых параметров (Recall: 41.87%), так и с корректностью их извлечения или классификации (Precision: 51.83%).\n*   **Ошибки форматирования JSON:** 9 из X тестов вернули невалидный JSON, что является критической проблемой, делающей результаты модели непригодными для автоматической обработки. Это указывает на то, что модель либо не поняла, что требуется JSON, либо испытывает трудности с его генерацией.\n*   **Некорректное или неполное извлечение диапазонов/операторов:**\n    *   Модель может предсказывать `[значение, None]` для одиночных значений (`N: предсказано [17.0, None], истина 17.0`) вместо `[17.0, 17.0]` или просто `17.0` (если допускается).\n    *   Проблемы с распознаванием \"не менее/не более\" и их корректным представлением с `null` (`NH4+: предсказано отсутствует, истина [None, 0.5]`).\n*   **Семантическая путаница:**\n    *   Перепутывание похожих, но разных параметров: `Параметр масса: предсказано 1035000.0, истина отсутствует` (модель предсказала \"масса\", хотя ожидалось \"масса нетто\").\n    *   Неспособность четко различать близкие сущности: `масса нетто` vs `масса нетто единицы`.\n*   **Проблемы с распознаванием химических элементов/соединений:**\n    *   Путаница между `CI` и `Cl`.\n    *   Неспособность извлечь `NH4+` или `NH4-N` в некоторых случаях.\n*   **\"Галлюцинации\" (ложные срабатывания):** Модель извлекает сущности, которых нет в тексте (`Вещество CI: предсказано [1.0, 2.0], истина отсутствует`).\n*   **Неполное извлечение для сложных параметров:** Для параметра \"марка\" модель извлекла `npks-8`, но упустила детали `(npk 8:20:30)`, которые могли бы содержать дополнительные массовые доли.\n\n### 2. Причины ошибок парсинга JSON\n\nОсновная причина ошибок парсинга JSON, скорее всего, кроется в **отсутствии явного указания на необходимость вывода в формате JSON в промпте**. Хотя промпт детально описывает структуру извлекаемых данных (Название признака, Значение, Единица измерения), он нигде **не требует** обернуть эти данные в формат JSON, а тем более не предоставляет его структуру или пример. Модель, без такой явной инструкции, может генерировать текст в произвольной, наиболее естественной для неё форме, которая не является валидным JSON.\n\n### 3. Причины ошибок в извлечении данных\n\n*   **Недостаточная спецификация выходного формата (JSON):** Как упомянуто выше, это влияет на саму структуру ответа, не только на его содержимое.\n*   **Сложность и многослойность инструкций в промпте:** Промпт достаточно длинный и содержит множество правил, которые модель может забывать или не всегда применять последовательно:\n    *   Специфическая обработка диапазонов и операторов (`не менее`, `не более`).\n    *   Замена `Кальций` на `Ca`.\n    *   Замена `K` на `K2O`.\n    *   Приоритет данных из марки.\n    *   Использование точки как разделителя.\n    *   Маленькие буквы в названии признака.\n    Модель может испытывать трудности с одновременным учетом всех этих правил.\n*   **Ограниченная семантическая дифференциация модели:** Модель не всегда точно понимает тонкие различия между похожими терминами (`масса` vs `масса нетто`), что приводит к ошибкам классификации.\n*   **Недостаток контекстных примеров (few-shot learning):** Без демонстрации нескольких примеров \"текст -> правильный JSON-вывод\", модель хуже усваивает требуемый формат и логику извлечения.\n*   **Отсутствие штрафа за \"галлюцинации\"**: Модель генерирует сущности, которых нет в тексте, что говорит о необходимости более строгого контроля над генерацией.\n\n### 4. Рекомендации по улучшению промпта\n\n1.  **Явно укажите требование JSON-формата и предоставьте схему/пример:**\n    *   В начале или в конце промпта добавьте: \"Твой ответ должен быть **строго** в формате JSON. Используй следующий формат:\"\n    *   ```json\n        [\n          {\n            \"название_признака\": \"массовая доля N\",\n            \"значение\": [17.0, 17.0],\n            \"единица_измерения\": \"%\"\n          },\n          {\n            \"название_признака\": \"масса нетто\",\n            \"значение\": [1035000.0, 1035000.0],\n            \"единица_измерения\": \"кг\"\n          }\n          // ... другие примеры\n        ]\n        ```\n    *   Включите примеры для всех типов значений: одиночные числа, диапазоны, `[min, null]`, `[null, max]`.\n    *   Включите примеры для всех единиц измерения и \"пусто\" для стандарта.\n\n2.  **Уточните правило для одиночных значений в диапазонах:**\n    *   \"Если признак указан как одиночное число, укажи его в формате `[число, число]` (например, `17.0` -> `[17.0, 17.0]`).\"\n    *   Четко повторите, что для \"не менее\" и \"не более\" используются `null`: \"«не менее X» - `[X, null]`, «не более Y» - `[null, Y]`\".\n\n3.  **Разграничьте \"масса\", \"масса нетто\", \"масса нетто единицы\":**\n    *   Добавьте примеры или более четкие определения, если это возможно из вашего датасета. Например: \"Внимательно различай 'масса' (общее), 'масса нетто' (вес содержимого упаковки/груза), 'масса нетто единицы' (вес одной упаковки).\"\n\n4.  **Уточните извлечение из \"марки\":**\n    *   \"Если в марке (например, \"N7-P20-K30-S3\") содержится массовая доля вещества, извлеки ее *также* как отдельный признак (например, \"массовая доля N\": [7.0, 7.0], \"%\"). Параметр 'марка' должен содержать **полное строковое значение марки**.\"\n\n5.  **Усильте правила преобразований:**\n    *   \"Всегда преобразуй K в K2O для массовых долей. Всегда заменяй полные названия элементов на их химические символы.\"\n\n6.  **Сократите промпт, если возможно:** Если некоторые инструкции избыточны или модель их уже усвоила, можно попробовать их убрать, чтобы уменьшить когнитивную нагрузку. Однако, для данной задачи, скорее всего, потребуется более *четкое* структурирование, а не сокращение.\n\n7.  **Разделение инструкций:** Разделите инструкции на две основные секции: \"Что найти\" и \"Как это представить\".\n\n### 5. Рекомендации по настройке гиперпараметров\n\n*   **`max_new_tokens`:** 512 токенов обычно достаточно для извлечения структурированных данных. Если при генерации JSON ответы обрезаются, это значение можно увеличить. Однако, текущие JSON-ошибки указывают не на обрезку, а на неверный формат.\n*   **`temperature` (если не указана, предполагается значение по умолчанию):** Для задач извлечения информации и строгого форматирования рекомендуется использовать низкую температуру (например, 0.1-0.3). Это сделает ответы модели более детерминированными и менее склонными к \"галлюцинациям\" или отклонениям от формата.\n*   **`top_p`, `top_k`:** Также можно настроить эти параметры для контроля разнообразия генерации, уменьшая их для более сфокусированного и точного вывода.\n\n### 6. Общие рекомендации по улучшению качества\n\n1.  **Few-shot Learning (обучение на нескольких примерах):**\n    *   Включите в промпт 2-3 примера полного цикла: текст → *правильный, валидный JSON-ответ*. Эти примеры должны охватывать разнообразные сценарии (наличие диапазонов, разных единиц, \"прочих\" параметров, обработки марки и т.д.). Это критически важно для моделей, которые плохо следуют строгим инструкциям форматирования.\n\n2.  **Итеративная доработка промпта:**\n    *   После внедрения рекомендаций 4 и 5, проведите повторное тестирование.\n    *   Анализируйте новые ошибки и корректируйте промпт, целенаправленно добавляя правила для случаев, с которыми модель продолжает справляться плохо.\n\n3.  **Пост-обработка ответов модели:**\n    *   Внедрите скрипт, который будет пытаться исправить распространенные ошибки JSON (например, добавить закрывающие скобки, если они отсутствуют, или преобразовать невалидный JSON в наиболее близкий валидный).\n    *   Создайте правила для пост-коррекции значений или категорий, которые модель постоянно путает (например, если она часто путает \"масса\" с \"масса нетто\" для определенных контекстов).\n\n4.  **Файнтюнинг модели (если возможно):**\n    *   Для действительно высокой точности и надежности в такой специфической и строго формализованной задаче, файнтюнинг модели на большом датасете \"текст-JSON\" пар является наиболее эффективным решением. Это позволит модели усвоить специфику предметной области и требуемый формат вывода гораздо глубже, чем только через промпт.\n\n5.  **Валидация данных:**\n    *   Убедитесь, что \"истинные\" данные для сравнения (ground truth) максимально точны и однозначны, особенно в случаях, где модель испытывает трудности (например, различие между `CI` и `Cl`, или `масса` vs `масса нетто`).\n\nСосредоточившись на четком определении JSON-формата в промпте и предоставлении нескольких примеров, вы сможете значительно улучшить как валидность JSON-вывода, так и общую точность извлечения данных.",
    "model_used": "gemini-2.5-flash"
  }
}