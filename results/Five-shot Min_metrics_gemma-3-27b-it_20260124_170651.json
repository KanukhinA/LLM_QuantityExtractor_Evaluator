{
  "timestamp": "20260124_170651",
  "model_name": "gemma-3-27b-it",
  "interrupted": false,
  "processed_count": 100,
  "total_count": 100,
  "multi_agent_mode": null,
  "gpu_info": {
    "api": true
  },
  "gpu_memory_after_load_gb": 0.0,
  "gpu_memory_during_inference_gb": 0.0,
  "gpu_memory_during_inference_max_gb": 0.0,
  "gpu_memory_during_inference_min_gb": 0.0,
  "api_model": true,
  "average_response_time_seconds": 9.846189153194427,
  "parsing_error_rate": 0.0,
  "parsing_errors_count": 0,
  "quality_metrics": {
    "массовая доля": {
      "accuracy": 0.7606992544492545,
      "precision": 0.7669172932330827,
      "recall": 0.8429752066115702,
      "f1": 0.8031496062992126,
      "tp": 204,
      "fp": 62,
      "fn": 38,
      "ошибки": [
        "Вещество нерастворимого остатка: предсказано отсутствует, истина [None, 0.03]",
        "Вещество нерастворимый остаток: предсказано [None, 0.03], истина отсутствует",
        "Вещество частиц < 1 мм: предсказано отсутствует, истина 0.0",
        "Вещество частицы < 1 мм: предсказано 0.0, истина отсутствует",
        "Вещество вода: предсказано отсутствует, истина [None, 1.2]",
        "Вещество частиц 1-5 мм: предсказано отсутствует, истина 100.0",
        "Вещество H2O: предсказано [None, 1.2], истина отсутствует",
        "Вещество частиц < 6 мм: предсказано отсутствует, истина 100.0",
        "Вещество частицы 1-5 мм: предсказано 100.0, истина отсутствует",
        "Вещество частицы < 6 мм: предсказано 100.0, истина отсутствует"
      ]
    },
    "прочее": {
      "accuracy": 0.5662896932127701,
      "precision": 0.6349206349206349,
      "recall": 0.5769230769230769,
      "f1": 0.6045340050377833,
      "tp": 120,
      "fp": 69,
      "fn": 88,
      "ошибки": [
        "Параметр масса брутто: предсказано отсутствует, истина 1050.0",
        "Параметр масса брутто единицы: предсказано 1050.0, истина отсутствует",
        "Параметр количество товара: предсказано 1035000.0, истина отсутствует",
        "Параметр масса нетто: предсказано отсутствует, истина 1035000.0",
        "Параметр масса: предсказано 1584.0, истина отсутствует",
        "Параметр вес реквизита крепления: предсказано отсутствует, истина 1584.0",
        "Параметр масса п/э мешка: предсказано 20.0, истина отсутствует",
        "Параметр масса упаковки (мешки): предсказано отсутствует, истина 100.0",
        "Параметр количество п/э мешков: предсказано 1000.0, истина отсутствует",
        "Параметр масса п/э мешка (указана повторно): предсказано 100.0, истина отсутствует"
      ]
    }
  },
  "hyperparameters": {
    "max_new_tokens": 512,
    "model_name": "gemma-3-27b-it",
    "api_model": true
  },
  "prompt_template": "build_prompt3",
  "prompt_full_text": "\nТы — эксперт по извлечению численных и количественных характеристик из текстов о химических веществах и удобрениях.  \nТвоя задача:  \n\n1. Найти все численные признаки в тексте, например:  \n   - Массовую долю элементов (массовая доля N, массовая доля P2O5 и др.) в процентах.  \n   - Количество товара (кг, т, п/э мешки, вагон и др.).  \n   - Прочие численные показатели, указанные в тексте (марки, стандарты (ТУ, ГОСТ и др.), идентификаторы).  \n\n2. Выведи json по аналогии с этими примерами:\nТекст примера 1: СЛОЖНОЕ АЗОТНО-ФОСФОРНО-КАЛИЙНОЕ МИНЕРАЛЬНОЕ УДОБРЕНИЕ АЗОФОСКА (НИТРОАММОФОСКА), ГРАНУЛИРОВАННОЕ, С СОДЕРЖАНИЕМ МАССОВОЙ ДОЛИ АЗОТА 16 МАС.%, ФОСФОРА 16 МАС.%, КАЛИЯ 16 МАС.% В ПЕРЕСЧЕТЕ НА СУXОЙ БЕЗВОДНЫЙ ПРОДУКТ, СООТВЕТСТВУЕТ ТУ 2186-039-00203789 -2003, ОБЕСПЕЧИВАЕТ СБАЛАНСИРОВАННОЕ ПИТАНИЕ РАСТЕНИЙ В СЕЛЬСКОМ ХОЗЯЙСТВЕ, В ПОЛИПРОПИЛЕНОВЫХ МЕШКАХ ПО 50 КГ СЛОЖНОЕ АЗОТНО-ФОСФОРНО-КАЛИЙНОЕ МИНЕРАЛЬНОЕ УДОБРЕНИЕ АЗОФОСКА\nОтвет примера 1: \n{\n  \"массовая доля\": [\n    {\n      \"вещество\": \"N\",\n      \"массовая доля\": 16\n    },\n    {\n      \"вещество\": \"P2O5\",\n      \"массовая доля\": 16\n    },\n    {\n      \"вещество\": \"K2O\",\n      \"массовая доля\": 16\n    }\n  ],\n  \"прочее\": [\n    {\n      \"параметр\": \"стандарт\",\n      \"значение\": \"ТУ 2186-039-00203789-2003\"\n    },\n    {\n      \"параметр\": \"масса нетто единицы\",\n      \"масса\": 50,\n      \"единица\": \"кг\"\n    }\n  ]\n}\n\nТекст примера 2: СУЛЬФАТ КАЛИЯ, ДЛЯ ТЕХНИЧЕСКОГО ИСПОЛЬЗОВАНИЯ. КРИСТАЛЛИЧЕСКИЙ РАССЫПЧАТЫЙ ПОРОШОК БЕЛОГО ЦВЕТА С ЖЕЛТОВАТЫМ ОТТЕНКОМ, НЕ СОДЕРЖАЩИЙ МЕХАНИЧЕСКИХ ПРИМЕСЕЙ,УПАКОВАННЫЙ В БИГ-БЕГИ ПО 1000 КГ+5%. СОСТАВ: МАССОВАЯ ДОЛЯ КАЛИЯ (К2О)-50.0%,SO4 - 52,5% ХЛОР( CI)-1.0% ГИГРОСКОПИЧЕН. :\nОтвет примера 2: {\n  \"массовая доля\": [\n    {\n      \"вещество\": \"K2O\",\n      \"массовая доля\": 50.0\n    },\n    {\n      \"вещество\": \"SO4\",\n      \"массовая доля\": 52.5\n    },\n    {\n      \"вещество\": \"Cl\",\n      \"массовая доля\": 1.0\n    }\n  ],\n  \"прочее\": [\n    {\n      \"параметр\": \"масса брутто единицы\",\n      \"масса\": 1050,\n      \"единица\": \"кг\"\n    }\n  ]\n}\n\nТекст примера 3: НИТРАТ КАЛЬЦИЯ КОНЦЕНТРИРОВАННЫЙ.ГРАНУЛИРОВАННЫЙ ПРОДУКТ С СОДЕРЖ.МАС.ДОЛИ ОБЩЕГО АЗОТА 17%, АММОНИЙНОГО АЗОТА НЕ БОЛЕЕ 0,5%,КАЛЬЦИЯ НЕ МЕНЕЕ 32%.ПРИМ-СЯ В СЕЛЬСКОМ ХОЗЯЙСТВЕ,РОЗНИЧНОЙ ПРОДАЖЕ В КАЧЕСТВЕ МИНЕРАЛЬНОГО УДОБРЕНИЯ. :\nОтвет примера 3: \n{\n  \"массовая доля\": [\n    {\n      \"вещество\": \"N\",\n      \"массовая доля\": 17\n    },\n    {\n      \"вещество\": \"NH4+\",\n      \"массовая доля\": [null, 0.5]\n    },\n    {\n      \"вещество\": \"Ca\",\n      \"массовая доля\": [32, null]\n    }\n  ],\n  \"прочее\": []\n}\n\nТекст примера 4: КАЛИЙ СЕРНОКИСЛЫЙ ИЗ НЕФЕЛИНОВОГО СЫPЬЯ ТУ 20.15.52-089-05785164-2022, ПРЕДНАЗНАЧЕН ДЛЯ ПРИМЕНЕНИЯ В КАЧЕСТВЕ МИНЕРАЛЬНОГО УДОБРЕНИЯ В СЕЛЬСКОМ ХОЗЯЙСТВЕ, ПОЛУЧАЮТ ИЗ ВЕТВИ ТЕХНОЛОГИЧЕСКОГО ПРОЦЕССА ПРОИЗВОДСТВА СОДОПРОДУКТОВ ИЗ РАСТВОРОВ ГЛИНОЗЕМНОГО ПРОИЗВОДСТВА\nОтвет примера 4: \n{\n  \"массовая доля\": [],\n  \"прочее\": [\n    {\n      \"параметр\": \"стандарт\",\n      \"значение\": \"ТУ 20.15.52-089-05785164-2022\"\n    }\n  ]\n}\n\nТекст примера 5: СУЛЬФАТ КАЛИЯ (СОРТ ЭКСТРА), ДЛЯ ТЕХНИЧЕСКOГО ИСПОЛЬЗОВАНИЯ. КРИСТАЛЛИЧЕСКИЙ РАССЫПЧАТЫЙ ПОРОШОК БЕЛОГО ЦВЕТА С ЖЕЛТОВАТЫМ ОТТЕНКОМ, НЕ СОДЕРЖАЩИЙ МЕХАНИЧЕСКИХ ПРИМЕСЕЙ,УПАКОВАННЫЙ В МЕШКИ ПО 25КГ+-5%, ОБЩИЙ ВЕС БРУТТО С ПАЛЛЕТАМИ 21640 КГ. СОСТАВ:МА МАССОВАЯ ДОЛЯ КАЛИЯ (К2О)-51.0%,SO4 - 51,0% ХЛОР(CI)-1.0%, ГИГРОСКОПИЧЕН. :\nОтвет примера 5: \n{\n  \"массовая доля\": [\n    {\n      \"вещество\": \"K2O\",\n      \"массовая доля\": 51.0\n    },\n    {\n      \"вещество\": \"SO4\",\n      \"массовая доля\": 51.0\n    },\n    {\n      \"вещество\": \"Cl\",\n      \"массовая доля\": 1.0\n    }\n  ],\n  \"прочее\": [\n    {\n      \"параметр\": \"масса брутто единицы\",\n      \"масса\": 26.25,\n      \"единица\": \"кг\"\n    },\n    {\n      \"параметр\": \"масса брутто\",\n      \"масса\": 21640,\n      \"единица\": \"кг\"\n    }\n  ]\n}\n\n3. Выводи json результат **только после слова ОТВЕТ:**.\n\nТекст для анализа:\nКАЛИЙ СЕРНОКИСЛЫЙ ИЗ НЕФЕЛИНОВОГО СЫPЬЯ ТУ 20.15.52-089-05785164-2022, ПРЕДНАЗНАЧЕН ДЛЯ ПРИМЕНЕНИЯ В КАЧЕСТВЕ МИНЕРАЛЬНОГО УДОБРЕНИЯ В СЕЛЬСКОМ ХОЗЯЙСТВЕ, ПОЛУЧАЮТ ИЗ ВЕТВИ ТЕХНОЛОГИЧЕСКОГО ПРОЦЕССА ПРОИЗВОДСТВА СОДОПРОДУКТОВ ИЗ РАСТВОРОВ ГЛИНОЗЕМНОГО ПРОИЗВОДСТВА\n",
  "prompt_info": null,
  "parsing_errors": [],
  "total_samples": 100,
  "valid_json_count": 100,
  "invalid_json_count": 0,
  "gemini_analysis": {
    "status": "success",
    "analysis": "### Анализ результатов тестирования модели gemma-3-27b-it\n\nМодель gemma-3-27b-it демонстрирует хорошие способности к генерации структурированного JSON и неплохо справляется с извлечением массовой доли, но имеет значительные проблемы с категорией \"Прочее\" и, вероятно, с тонкостями извлечения данных (например, вычислениями).\n\n**Метрики качества:**\n\n*   **Массовая доля:** Accuracy: 76.07%, Precision: 76.69%, Recall: 84.30%, F1: 80.31%\n*   **Прочее:** Accuracy: 56.63%, Precision: 63.49%, Recall: 57.69%, F1: 60.45%\n*   Ошибок парсинга не обнаружено.\n\n---\n\n#### 1. Характерные ошибки модели\n\n*   **Категория \"Массовая доля\":**\n    *   **Низкая Precision (76.69%) при высокой Recall (84.30%):** Модель склонна к ложноположительным срабатываниям. Это означает, что она часто извлекает значения, которые *похожи* на массовую долю (например, другие проценты или числа), но не являются ею, или неправильно ассоциирует вещество со значением. Она скорее найдет что-то лишнее, чем пропустит необходимое.\n    *   **Возможные ошибки:** Неправильная идентификация вещества (например, путает \"N\" с \"NO3-\", если это не указано в примере), ошибочное включение других процентных показателей (например, влажность, чистота, если они не являются массовой долей конкретного элемента/оксида), неправильная интерпретация контекста.\n\n*   **Категория \"Прочее\":**\n    *   **Низкие все метрики (F1: 60.45%):** Эта категория является основным слабым местом модели.\n    *   **Низкий Recall (57.69%):** Модель пропускает значительную часть сущностей, которые должны быть отнесены к \"прочему\". Это может быть связано с разнообразием форматов стандартов, идентификаторов или способов указания количества.\n    *   **Относительно низкая Precision (63.49%):** Хотя Precision выше Recall, она всё равно оставляет желать лучшего. Модель не всегда правильно классифицирует данные как \"прочее\" или ошибается при извлечении самого значения (например, извлекает некорректную часть стандарта или неверно вычисляет массу).\n    *   **Особые проблемы:** Вероятно, трудности с вычислением масс на основе процентов (например, \"1000 кг + 5%\"), с распознаванием всех форматов стандартов (ТУ, ГОСТ) или с обработкой сложных текстовых описаний количества товара.\n\n---\n\n#### 2. Причины ошибок парсинга JSON\n\n**Ошибок парсинга JSON не обнаружено**, что является очень позитивным результатом. Это свидетельствует о том, что модель хорошо усвоила требуемый формат вывода и успешно генерирует синтаксически корректный JSON, следуя структуре, заданной в промпте и примерах. Это снижает необходимость в корректировке инструкций, касающихся *формата* JSON.\n\n---\n\n#### 3. Причины ошибок в извлечении данных\n\n*   **Недостаточное понимание контекста и семантики:** Модель может путать численные значения, которые похожи по формату (например, числа с процентами), но имеют разное семантическое значение (массовая доля vs. влажность).\n*   **Сложность выделения разнородных сущностей в \"Прочее\":** Категория \"прочее\" очень широка и включает в себя стандарты (разнообразные паттерны), количество товара (с разными единицами измерения и иногда требующее вычислений), и другие идентификаторы. Универсальные правила для такой разнородности могут быть сложны для модели без достаточного количества примеров.\n*   **Неспособность к точным арифметическим вычислениям:** Модели LLM по своей природе не являются калькуляторами. Примеры \"1000 КГ+5%\" -> 1050 или \"25КГ+-5%\" -> 26.25 требуют выполнения арифметических операций, с которыми LLM часто справляются неоптимально, если это не заложено в их тренировочных данных или не подкреплено очень сильными примерами.\n*   **Неполный охват типов веществ и параметров:** Возможно, промпт и примеры не охватывают все возможные варианты названий веществ, типов стандартов или описаний количества, которые встречаются в реальных текстах.\n*   **Нечеткое определение границ извлекаемых значений:** Например, при извлечении стандарта \"ТУ 20.15.52-089-05785164-2022\", модель может ошибочно захватить лишние слова или, наоборот, пропустить часть идентификатора.\n*   **Обработка диапазонов и пороговых значений:** В примере 3 показано, как \"не более 0,5%\" преобразуется в `[null, 0.5]` и \"не менее 32%\" в `[32, null]`. Это сложная логика, требующая точной интерпретации лингвистических конструкций.\n\n---\n\n#### 4. Рекомендации по улучшению промпта\n\nПоскольку ошибки парсинга отсутствуют, фокус должен быть на улучшении точности и полноты извлечения данных.\n\n1.  **Больше детализации для \"Массовой доли\":**\n    *   **Перечислить синонимы/варианты названий:** Явно указать, как модель должна маппить различные формулировки (например, \"общий азот\", \"аммонийный азот\", \"нитратный азот\") к соответствующим коротким обозначениям (\"N\", \"NH4+\", \"NO3-\").\n    *   **Уточнить исключения:** Прямо указать, какие процентные значения *не* являются массовой долей (например, \"влажность не более X%\", \"растворимость Y%\", если они не относятся к составу вещества).\n\n2.  **Значительное расширение и уточнение для \"Прочее\":**\n    *   **Разнообразить примеры стандартов:** Добавить примеры с разными форматами ГОСТ, СТО, ТУ, если они встречаются.\n    *   **Детализировать обработку количества товара:**\n        *   Явно указать, что модель должна *вычислять* конечную массу, если даны процентные отклонения (например, \"Х кг +- Y%\", \"Х кг + Y%\"). Добавить больше таких примеров.\n        *   Перечислить возможные типы единиц измерения (\"кг\", \"т\", \"мешки\", \"вагон\", \"биг-беги\") и соответствующие ключи (\"масса нетто единицы\", \"масса брутто единицы\", \"масса брутто\").\n    *   **Добавить примеры других численных показателей:** Если есть другие важные \"прочие\" числовые характеристики, добавить их в примеры.\n\n3.  **Усилить правила обработки диапазонов/неравенств:**\n    *   В секции \"2. Выведи json по аналогии с этими примерами:\" добавить более явное правило для `[null, X]` и `[X, null]`, возможно, с кратким текстовым пояснением после примера.\n\n4.  **Количество примеров (Few-shot learning):**\n    *   Увеличить количество примеров в промпте (сейчас их 5). Особенно важно добавить больше разнообразных примеров для категории \"прочее\" и для случаев, требующих вычислений или обработки диапазонов. Цель – охватить как можно больше edge-кейсов.\n\n5.  **Разделение инструкций (если промпт станет слишком большим):**\n    *   Если промпт станет слишком длинным, можно рассмотреть возможность разделения инструкций на более мелкие блоки или использования более четкой иерархии для улучшения читаемости.\n\n---\n\n#### 5. Рекомендации по настройке гиперпараметров\n\nТекущие гиперпараметры:\n`max_new_tokens`: 512 (достаточно для текущей задачи)\n`model_name`: gemma-3-27b-it\n`api_model`: true\n\n*   **Температура (temperature):**\n    *   Поскольку для \"Массовой доли\" наблюдаются ложноположительные срабатывания (Precision ниже Recall), а для \"Прочее\" низкие все метрики, рекомендуется **снизить температуру (например, до 0.1-0.3)**. Это сделает вывод модели более детерминированным и сосредоточенным на наиболее вероятных токенах, что может улучшить Precision и снизить \"галлюцинации\". Однако это может также немного снизить Recall, если модель станет слишком консервативной. Найдите оптимальный баланс через эксперименты.\n*   **Top-p / Top-k:**\n    *   Если они не установлены явно, модель использует значения по умолчанию. Для задач извлечения фактов обычно рекомендуется использовать **более низкие значения Top-p (например, 0.5-0.7) и/или Top-k (например, 20-50)**, чтобы ограничить выбор токенов и получить более точный, менее разнообразный результат.\n\n---\n\n#### 6. Общие рекомендации по улучшению качества\n\n1.  **Дообучение (Fine-tuning):** Если существующие рекомендации по промпту и гиперпараметрам не дают достаточного улучшения, наиболее эффективным методом будет дообучение модели на большом, специально размеченном датасете. Это позволит модели глубоко изучить специфические паттерны извлечения информации из текстов о химических веществах и удобрениях, включая сложные правила маппинга и вычислений.\n\n2.  **Больше качественных примеров (для Few-shot Learning):** Даже без полного дообучения, увеличение количества и разнообразия примеров в промпте (до 10-15 и более, если позволяет контекстное окно) может значительно улучшить производительность. Сосредоточьтесь на примерах, которые иллюстрируют сложные случаи:\n    *   Вычисления массы (например, \"X кг +/- Y%\").\n    *   Обработка диапазонов (`[min, max]`).\n    *   Различные форматы стандартов.\n    *   Случаи, где модель часто совершает ошибки (ложноположительные для массовой доли, пропуски для \"прочее\").\n\n3.  **Разбиение задачи (Chain-of-Thought / Task Orchestration):** Для особо сложных случаев, таких как арифметические вычисления, можно рассмотреть подход, при котором модель сначала извлекает сырые данные (например, \"1000 КГ\", \"+5%\"), а затем эти данные передаются внешнему калькулятору или скрипту для точного расчета, после чего результат возвращается модели для формирования финального JSON. Это позволяет использовать сильные стороны каждой системы.\n\n4.  **Пост-обработка и валидация:** Внедрение этапа пост-обработки для валидации извлеченных данных. Например, проверка, что массовая доля не превышает 100%, что извлеченные единицы измерения соответствуют ожидаемым, или исправление мелких ошибок форматирования.\n\n5.  **Итеративный подход:** Процесс улучшения качества LLM и промпта является итеративным. Регулярно тестируйте модель на новых данных, анализируйте ошибки и используйте эти знания для дальнейшей доработки промпта и/или настроек модели.",
    "model_used": "gemini-2.5-flash"
  },
  "ошибки": {
    "примеры_текстов": [],
    "список_ошибок": []
  }
}