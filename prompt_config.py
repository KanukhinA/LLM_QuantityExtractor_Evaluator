"""
Конфигурация промптов для обработки текстов
"""

# Базовый промпт для извлечения численных характеристик из текстов об удобрениях
FERTILIZER_EXTRACTION_PROMPT_TEMPLATE = """
Ты — эксперт по извлечению численных и количественных характеристик из текстов о химических веществах и удобрениях.  
Твоя задача:  

1. Найти все численные признаки в тексте, например:  
   - Массовую долю элементов (массовая доля N, массовая доля P2O5 и др.) в процентах.  
   - Количество товара (кг, т, п/э мешки, вагон и др.).  
   - Прочие численные показатели, указанные в тексте (марки, стандарты (ТУ, ГОСТ и др.), идентификаторы).  

2. Для каждого численного признака определить:  
   - Название признака (например, "массовая доля N", "массовая доля P2O5", "массовая доля К2О", "массовая доля S", "масса нетто единицы", "масса нетто", "масса K2O", "масса брутто", "количество вагонов", "стандарт" и т.д.)  
   - Значение (число, если есть диапазон — брать оба значения; для стандарта указываешь полный номер стандарта со словами ГОСТ/ТУ или др.)  
   - Единицу измерения (%, кг, т, шт, п/э меш, вагон, или пусто для стандарта)  

3. Особые указания:
   - Извлекай на русском
   - Если признак указан как диапазон из нескольких чисел (например "8-10", или "от 6 до 12") или с погрешностью (+/-), укажи оба числа в формате [min, max]. 
   - Извлекай логические/сравнительные операторы, если они присутствуют в тексте: «не менее» - [min, null] «не более» - [null, max]
   - Используй точку в качестве разделителя десятичных чисел.
   - Название вещества и его массовая доля могут встречаться в марке (например, "N7-P20-K30-S3"),  используй данные из марки, если нет иных данных по массовой доле вещества.
   - Если в названии признака есть название химического элемента (например Кальций) - замени его на обозначение химического элемента - Ca.
   - Названия признаков пиши с маленькой буквы. Например "массовая доля Zn".
   - Если указано например "МАССОВАЯ ДОЛЯ K В ПЕРЕСЧЕТЕ НА К2О" - то правильным извлекаемым признаком будет "массовая доля K2O".
   - Если один и тот же параметр встречается дважды — сначала как общее условие (например, «с содержанием азота более 10%»), а затем как конкретное значение (например, «азот 16%»), указывай только конкретное значение.
   - Для массы с упаковкой - называй признак "масса брутто" вне зависимости от наименования упаковки. Если указывается просто масса в формате "МЕШКИ ПО 50 КГ" - это признак "масса нетто".
   - Если дается масса в виде "ПО 1000 КГ+5%" - указывай в признаке "масса брутто" одно значение - 1050.
   - Для прочих признаков (всех признаков, помимо "массовой доли") указывай единицы измерения (за исключением признаков "марка" и "стандарт")
   - Если признака в тексте нет - не извлекай его и не выводи его в json.

4 . Выводи строго JSON следующего вида (пример):

```json
{{
  "массовая доля": [
    {{"вещество": "N", "массовая доля": [26, 28]}},
    {{"вещество": "P2O5", "массовая доля": [20, null]}},
    {{"вещество": "K2O", "массовая доля": 20}},
    {{"вещество": "S", "массовая доля": 3}},
    {{"вещество": "NH4+", "массовая доля": [null, 2]}}
  ],
  "прочее": [
    {{"параметр": "масса нетто единицы", "масса": 50, "единица": "кг"}},
    {{"параметр": "масса брутто", "масса": 1020, "единица": "кг"}},
    {{"параметр": "количество поддонов", "количество": 20, "единица": "шт"}},
    {{"параметр": "количество мешков", "количество": 1000, "единица": "шт"}},
    {{"параметр": "объем нетто единицы", "объем": 10, "единица": "л"}},
    {{"параметр": "стандарт", "значение": "ТУ 2184-037-32496445-02"}},
    {{"параметр": "марка", "значение": "N7-P20-K30-S3"}}
  ]
}}
```

5. Выводи json результат **только после слова ОТВЕТ:**.

Текст для анализа:
{text}
"""

# Базовый промпт с примером текста и ответа
FERTILIZER_EXTRACTION_PROMPT_WITH_EXAMPLE = """
Ты — эксперт по извлечению численных и количественных характеристик из текстов о химических веществах и удобрениях.  
Твоя задача:  

1. Найти все численные признаки в тексте, например:  
   - Массовую долю элементов (массовая доля N, массовая доля P2O5 и др.) в процентах.  
   - Количество товара (кг, т, п/э мешки, вагон и др.).  
   - Прочие численные показатели, указанные в тексте (марки, стандарты (ТУ, ГОСТ и др.), идентификаторы).  

2. Для каждого численного признака определить:  
   - Название признака (например, "массовая доля N", "массовая доля P2O5", "массовая доля К2О", "массовая доля S", "масса нетто единицы", "масса нетто", "масса K2O", "масса брутто", "количество вагонов", "стандарт" и т.д.)  
   - Значение (число, если есть диапазон — брать оба значения; для стандарта указываешь полный номер стандарта со словами ГОСТ/ТУ или др.)  
   - Единицу измерения (%, кг, т, шт, п/э меш, вагон, или пусто для стандарта)  

3. Особые указания:
   - Извлекай на русском
   - Если признак указан как диапазон из нескольких чисел (например "8-10", или "от 6 до 12") или с погрешностью (+/-), укажи оба числа в формате [min, max]. 
   - Извлекай логические/сравнительные операторы, если они присутствуют в тексте: «не менее» - [min, null] «не более» - [null, max]
   - Используй точку в качестве разделителя десятичных чисел.
   - Название вещества и его массовая доля могут встречаться в марке (например, "N7-P20-K30-S3"),  используй данные из марки, если нет иных данных по массовой доле вещества.
   - Если в названии признака есть название химического элемента (например Кальций) - замени его на обозначение химического элемента - Ca.
   - Названия признаков пиши с маленькой буквы. Например "массовая доля Zn".
   - Если указано например "МАССОВАЯ ДОЛЯ K В ПЕРЕСЧЕТЕ НА К2О" - то правильным извлекаемым признаком будет "массовая доля K2O".
   - Если один и тот же параметр встречается дважды — сначала как общее условие (например, «с содержанием азота более 10%»), а затем как конкретное значение (например, «азот 16%»), указывай только конкретное значение.
   - Для массы с упаковкой - называй признак "масса брутто" вне зависимости от наименования упаковки. Если указывается просто масса в формате "МЕШКИ ПО 50 КГ" - это признак "масса нетто".
   - Если дается масса в виде "ПО 1000 КГ+5%" - указывай в признаке "масса брутто" одно значение - 1050.
   - Для прочих признаков (всех признаков, помимо "массовой доли") указывай единицы измерения (за исключением признаков "марка" и "стандарт")
   - Если признака в тексте нет - не извлекай его и не выводи его в json.

4. Выводи строго JSON следующего вида (пример):

Пример текста:
НИТРОАММОФОСКА, УДОБРЕНИЕ МИНЕРАЛЬНОЕ, СОДЕРЖАЩЕЕ ТРИ ПИТАТЕЛЬНЫХ ЭЛЕМЕНТА - АЗОТ-27 +-1%, ФОСФОР-20% (В ПЕРЕСЧЕТЕ НА P2O5), КАЛИЙ-20% (В ПЕРЕСЧЕТЕ НА K2O), СЕРА-3%. ПОСТАВЛЯЕТСЯ В МЕШКАХ ПО 50 КГ. МАССА БРУТТО С УПАКОВКОЙ: 1020 КГ. КОЛИЧЕСТВО ПОДДОНОВ: 20 ШТ. КОЛИЧЕСТВО МЕШКОВ: 1000 ШТ. ОБЪЕМ НЕТТО ЕДИНИЦЫ: 10 Л. СООТВЕТСТВУЕТ ТУ 2184-037-32496445-02. МАРКА: N26-P20-K20-S3.

Пример ответа:
```json
{{
  "массовая доля": [
    {{"вещество": "N", "массовая доля": [26, 28]}},
    {{"вещество": "P2O5", "массовая доля": 20}},
    {{"вещество": "K2O", "массовая доля": 20}},
    {{"вещество": "S", "массовая доля": 3}}
  ],
  "прочее": [
    {{"параметр": "масса нетто единицы", "масса": 50, "единица": "кг"}},
    {{"параметр": "масса брутто", "масса": 1020, "единица": "кг"}},
    {{"параметр": "количество поддонов", "количество": 20, "единица": "шт"}},
    {{"параметр": "количество мешков", "количество": 1000, "единица": "шт"}},
    {{"параметр": "объем нетто единицы", "объем": 10, "единица": "л"}},
    {{"параметр": "стандарт", "значение": "ТУ 2184-037-32496445-02"}},
    {{"параметр": "марка", "значение": "N26-P20-K20-S3"}}
  ]
}}
```

5. Выводи json результат **только после слова ОТВЕТ:**.

Текст для анализа:
{text}
"""

# Промпт для агента извлечения числовых фрагментов
NUMERIC_FRAGMENTS_EXTRACTION_PROMPT = """
Ты — агент извлечения количественных атрибутов продукта из технического текста.

Твоя задача — найти и извлечь все фрагменты текста, которые выражают
измеримые, нормируемые или спецификационные свойства продукта.

Извлекаемый фрагмент должен представлять собой:
> «Сущность продукта + числовое значение + (при необходимости) единицы / допуск / стандарт»

То есть это должен быть осмысленный количественный атрибут, который может быть
нормализован, сопоставлен и сравним в последующих шагах обработки.

### ЧТО СЧИТАЕТСЯ АТРИБУТОМ

Извлекай фрагменты, описывающие:

#### 1. Состав и концентрации
- Массовые, молярные и процентные доли
  (Азот 16%, P2O5 20%, содержание влаги не более 1.5%)
- Формулы и марки удобрений
  (N7-P20-K30-S3, 10-26-26)

#### 2. Физические и логистические характеристики
- Масса, объём, фасовка, упаковка
  (мешки по 50 кг, биг-бэг 1000 кг, 25 л)
- Плотность, насыпная масса, влажность и т.п.

#### 3. Диапазоны, допуски, ограничения
- ±, от…до…, не более, не менее, в пределах
  (16% ±1%, от 6 до 12 г/л, не более 5%)

#### 4. Нормативные числовые идентификаторы
- ГОСТ, ТУ, ISO, EN и аналогичные стандарты с номерами

### ЧТО НЕ ИЗВЛЕКАТЬ

Не извлекай:
- Даты, годы, номера партий
- Телефоны, адреса, ИНН, артикулы
- Позиционные номера, номера строк, страниц
- Любые числа, не описывающие свойство продукта

### ПРАВИЛА ИЗВЛЕЧЕНИЯ ФРАГМЕНТОВ

1. Ты извлекаешь подстроки исходного текста, без перефразирования.
2. Фрагмент должен быть минимальным, но семантически полным:
   он должен включать:
   - что измеряется
   - и сколько
3. Если рядом есть допуск или диапазон — включай его в тот же фрагмент:
   правильно: «Азот 16% ±1%»  
   неправильно: «Азот 16%» и «±1%» отдельно
4. Если рядом несколько разных атрибутов — каждый извлекай отдельно.
5. Если число относится к слову, оно должно быть извлечено вместе с этим словом:
   правильно: «мешках по 50 кг»  
   неправильно: «50 кг»

### ПРИМЕР

Текст:
НИТРОАММОФОСКА, содержащая азот 16% ±1%, фосфор 16%, калий 16%, поставляется в мешках по 50 кг.

Правильные фрагменты:
Азот 16% ±1%
Фосфор 16%
Калий 16%
В мешках по 50 кг

### ТЕКСТ ДЛЯ АНАЛИЗА:
{text}
"""

# Промпт для агента извлечения массовых долей
MASS_FRACTION_EXTRACTION_PROMPT = """
Ты — эксперт по извлечению массовых долей элементов из текстов об удобрениях.

Твоя задача: из найденных числовых фрагментов извлечь только информацию о массовых долях химических элементов.

Массовая доля может быть указана:
- Прямо: "массовая доля N 26%", "азот 16%", "N 26-28%"
- В марке: "N7-P20-K30-S3" означает N=7%, P2O5=20%, K2O=30%, S=3%
- С операторами: "не менее 10%", "не более 20%"

Правила:
- Если указано "МАССОВАЯ ДОЛЯ K В ПЕРЕСЧЕТЕ НА К2О" - это "массовая доля K2O"
- Если в марке указана доля - используй её, если нет прямого указания
- Диапазоны указывай как [min, max]
- Операторы: «не менее» - [min, null], «не более» - [null, max]
- Названия элементов заменяй на химические обозначения (Кальций -> Ca)
- Названия признаков пиши с маленькой буквы

Выведи список найденных массовых долей в формате:
вещество: значение (или [min, max] для диапазона)
Например:
N: [16, 18]

Если массовых долей нет, выведи "Массовых долей не найдено".

Числовые фрагменты для анализа:
{numeric_fragments}
"""

# Промпт для агента извлечения прочих параметров
OTHER_PARAMETERS_EXTRACTION_PROMPT = """
Ты — эксперт по извлечению прочих количественных параметров из текстов об удобрениях.

Твоя задача: из найденных числовых фрагментов извлечь все параметры, КРОМЕ массовых долей элементов.

Ищи:
- Массу нетто единицы (например, "мешки по 50 кг" -> масса нетто: 50 кг)
- Массу брутто (масса с упаковкой)
- Количество (мешков, поддонов, вагонов и др.)
- Объем нетто единицы
- Стандарты (ГОСТ, ТУ и др.)
- Марки (если не использованы для массовых долей)

Правила:
- "МЕШКИ ПО 50 КГ" -> масса нетто: 50 кг
- "ПО 1000 КГ+5%" -> масса брутто: 1050 кг
- Для массы с упаковкой всегда "масса брутто"
- Указывай единицы измерения (кроме "марка" и "стандарт")
- Если параметра нет - не выводи его

Выведи список найденных параметров в формате:
параметр: значение единица

Если прочих параметров нет, выведи "Прочих параметров не найдено".

Числовые фрагменты для анализа:
{numeric_fragments}
"""

# Упрощенный и пояснительный промпт для маленьких моделей (например, gemma-2b)
JSON_FORMATION_PROMPT = """
Ты агент, который формирует структурированный ответ в формате JSON.

1. Объедини все массовые доли и прочие параметры в один JSON, строго по показанному образцу ниже.
2. Если каких-то данных нет — выведи пустой список [] для этого поля.
3. Все числа дай через точку, если есть десятичные.
4. Для диапазона используй [min, max], [min, null] или [null, max].
5. Для "стандарт" и "марка" используй поле "значение".
6. Строго следуй названию каждого поля как в примере! Не добавляй ничего лишнего.

Пример ответа:
ОТВЕТ:
```json
{{
  "массовая доля": [
    {{"вещество": "N", "массовая доля": [26, 28]}},
    {{"вещество": "P2O5", "массовая доля": [20, null]}},
    {{"вещество": "K2O", "массовая доля": 20}},
    {{"вещество": "S", "массовая доля": 3}}
  ],
  "прочее": [
    {{"параметр": "масса нетто единицы", "масса": 50, "единица": "кг"}},
    {{"параметр": "масса брутто", "масса": 1020, "единица": "кг"}},
    {{"параметр": "стандарт", "значение": "ТУ 2184-037-32496445-02"}},
    {{"параметр": "марка", "значение": "N7-P20-K30-S3"}}
  ]
}}

В начале обязательно выведи: ОТВЕТ:

Возьми данные для заполнения json отсюда:

Массовые доли:
{mass_fractions}

Прочие параметры:
{other_parameters}
"""

# Промпт для агента-критика (поиск несоответствий)
# CRITIC_PROMPT = """
# Ты — эксперт-критик, который анализирует ответы моделей на предмет соответствия исходному промпту.

# Твоя задача:
# 1. Проанализировать исходный промпт и ответ модели
# 2. Найти все несоответствия между промптом и ответом:
#    - Пропущенные данные, которые должны были быть извлечены
#    - Неправильно извлеченные данные
#    - Нарушения формата вывода (например, не JSON, неправильная структура JSON)
#    - Логические ошибки в данных
#    - Несоответствия требованиям промпта

# 3. Вывести список найденных проблем в формате JSON:

# ```json
# {{
#   "найдены_ошибки": true/false,
#   "ошибки": [
#     {{
#       "тип": "пропущенные_данные" | "неправильные_данные" | "формат" | "логика" | "требования",
#       "описание": "детальное описание проблемы",
#       "критичность": "критичная" | "средняя" | "низкая"
#     }}
#   ]
# }}
# ```

# Если ошибок не найдено, выведи:
# ```json
# {{
#   "найдены_ошибки": false,
#   "ошибки": []
# }}
# ```

# Исходный промпт:
# {prompt}

# Ответ модели:
# {response}

# Выведи анализ в формате JSON после слова ОТВЕТ:.
# """

CRITIC_PROMPT = """
Ты — строгий и объективный эксперт-критик. Твоя задача — **только проверять соответствие ответа модели исходному промпту**, учитывая контекст тематики исходного промпта и ответа модели.  
**Не добавляй требований, которых нет в исходном промпте.**
### Правила анализа:
1. Сравни **только то, что явно указано в исходном промпте**.
2. Ошибки считаются **только если нарушено конкретное требование** из исходного промпта.
3. **Не считай ошибкой отсутствие единиц измерения, пояснений, форматирования или данных, если они не были прямо запрошены**.
4. **Не выдумывай ошибки** ради заполнения списка. Если всё соответствует — ошибок нет.
### Типы возможных ошибок:
- `"пропущенные_данные"` — если промпт требовал извлечь/указать конкретное значение, а его нет в ответе.
- `"неправильные_данные"` — если значение в ответе противоречит информации из контекста или промпта.
- `"формат"` — если промпт явно указал формат (например: "выведи JSON", "используй список"), а ответ ему не соответствует.
- `"логика"` — только если промпт содержал логическое условие или вычисление, и оно выполнено неверно.
- `"иные требования"` — если нарушено любое другое явное требование из промпта

После анализа выведи блок JSON в следующем формате, после слова `ОТВЕТ:`:

```json
{{
  "найдены_ошибки": false,
  "ошибки": []
}}
или если есть ошибки
{{
  "найдены_ошибки": true,
  "ошибки": [
    {{
      "тип": "...",
      "описание": "Кратко и точно: что именно нарушено в сравнении с промптом?",
      "критичность": "критичная" | "средняя" | "низкая"
    }}
  ]
}}

Исходный промпт:
{prompt}

Ответ модели для оценки:
{response}

"""

# Промпт для агента-исправителя (устранение ошибок)
CORRECTOR_PROMPT = """
Ты — эксперт-исправитель, который устраняет ошибки в ответах моделей на основе критики.

Твоя задача:
1. Получить исходный промпт, исходный ответ модели и список найденных ошибок
2. Исправить все найденные ошибки в ответе модели
3. Вывести исправленный ответ в том же формате, что и исходный ответ

Важно:
- Сохраняй структуру исходного ответа
- Исправляй только найденные ошибки, не меняй корректные части
Выведи результат в формате JSON после слова ОТВЕТ:

Исходный промпт:
{prompt}

Исходный ответ модели:
{original_response}

Найденные ошибки:
{critic_analysis}

Выведи исправленный ответ после слова ОТВЕТ:.
"""

QA_NUTRIENTS_PROMPT = """
Текст: {text}

Вопрос: Какие действующие вещества (питательные элементы или их соединения) указаны в этом удобрении? Извлекай только те, что относятся к агрохимическому составу:  
— Азот как N,  
— Фосфор как P2O5,  
— Калий как K2O,  
— Сера как S,  
— Кальций как Ca,  
— Магний как Mg,  
— Цинк как Zn,  
— и другие макро-/микроэлементы в стандартной форме.  

Если в марке указано, например, "N7-P20-K30", извлекай: N, P2O5, K2O.  
Если сказано "K в пересчёте на K2O" — указывай K2O.  
Не включай упаковку, стандарты, массу, объём.

Ответ должен быть строго списком строк в формате JSON. Примеры:

Пример текста: Удобрение NPK 16-20-20 содержит азот, фосфор (в виде P2O5) и калий (в виде K2O).
Пример ответа: 
```json
["N", "P2O5", "K2O"]
```

Пример текста: Марка N7-P20-K30-S3
Пример ответа: 
```json
["N", "P2O5", "K2O", "S"]
```

Пример текста: Гранулированное удобрение в мешках по 50 кг. Соответствует ТУ 12345.
Пример ответа: 
```json
[]
```

Отвечай только текстом в формате JSON после слова ОТВЕТ:
"""

QA_NUTRIENT_PROMPT = """
Контекст:
{text}

Вопрос:
Какова массовая доля {substance} в удобрении? Учти, что:
- Если указано "K в пересчёте на K2O" — это означает массовую долю K2O.
- Если значение дано как диапазон (например, "8–10" или "от 6 до 12"), верни [min, max].
- Если указано "не менее X" — верни [X, null].
- Если указано "не более X" — верни [null, X].
- Если значение одно — верни число (например, 20).
- Используй точку как десятичный разделитель.
- Если информации нет — верни null.

Ответ должен быть только в формате JSON, соответствующим структуре элемента массива "массовая доля":

Примеры ответов:
{{"вещество": "N", "массовая доля": [26, 28]}}
{{"вещество": "P2O5", "массовая доля": [20, null]}}
{{"вещество": "S", "массовая доля": 3}}
{{"вещество": "NH4+", "массовая доля": [null, 2]}}
{{"вещество": "N", "массовая доля": null}}

Отвечай только текстом в формате JSON после слова ОТВЕТ:
"""

QA_STANDARD_PROMPT = """
Контекст:
{text}

Вопрос:
Какой стандарт (ГОСТ, ТУ, СТО или другой нормативный документ) указан для этого удобрения?  
Если стандарт не указан — верни null.

Ответ должен быть только в формате JSON, соответствующим структуре элемента массива "прочее":

Примеры ответов:
{{"параметр": "стандарт", "значение": "ТУ 2184-037-32496445-02"}}
{{"параметр": "стандарт", "значение": null}}

Отвечай только текстом в формате JSON после слова ОТВЕТ:
"""

QA_GRADE_PROMPT = """
Контекст:
{text}

Вопрос:
Какая марка удобрения указана (например, N7-P20-K30-S3)?  
Если марка не указана — верни null.

Ответ должен быть только в формате JSON, соответствующим структуре элемента массива "прочее":

Примеры ответов:
{{"параметр": "марка", "значение": "N7-P20-K30-S3"}}
{{"параметр": "марка", "значение": null}}

Отвечай только текстом в формате JSON после слова ОТВЕТ:
"""

QA_QUANTITY_PROMPT = """
Контекст:
{text}

Вопрос:
Какое количество товара указано в тексте? Это может быть:
- масса (в кг, т и др.),
- объём (в л, м³ и др.),
- число упаковок (мешков, канистр, вагонов, поддонов, паллет и т.д.),
- любая другая числовая характеристика количества.

Извлеки:
1. **Числовое значение** (если указано "1000 мешков" → 1000; "5 т" → 5; "мешки по 50 кг" → 50).
2. **Единицу измерения** (например: "кг", "т", "шт", "меш", "вагон", "л", "паллета" и т.д. — как в тексте, но в нижнем регистре и без сокращений типа "п/э").
3. Если указан допуск (например, "+5%"), учти его: "1000 кг+5%" → 1050.

Правила:
- Извлекай **только то, что явно указано**.
- Не суммируй, не интерполируй, не вычисляй общее количество, если оно не дано напрямую.
- Если количество не указано — верни null.

Ответ должен быть строго в формате JSON, соответствующим структуре элемента массива "прочее":

Примеры ответов:
{{"параметр": "масса нетто единицы", "масса": 50, "единица": "кг"}}
{{"параметр": "масса брутто", "масса": 1020, "единица": "кг"}}
{{"параметр": "количество поддонов", "количество": 20, "единица": "шт"}}
{{"параметр": "количество мешков", "количество": 1000, "единица": "шт"}}
{{"параметр": "объем нетто единицы", "объем": 10, "единица": "л"}}

Для масс используй поле "масса", для количеств - "количество", для объемов - "объем". Определяй тип параметра по единице измерения и контексту.

Отвечай только текстом в формате JSON после слова ОТВЕТ:
"""
